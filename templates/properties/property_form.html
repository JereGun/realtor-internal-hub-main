{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}
        Editar {{ object.title }} - {{ block.super }}
    {% else %}
        Nueva Propiedad - {{ block.super }}
    {% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}
        Editar Propiedad
    {% else %}
        Nueva Propiedad
    {% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        {% if object %}
            Editar: {{ object.title }}
        {% else %}
            Nueva Propiedad
        {% endif %}
    </h2>
    <a href="{% if object %}{% url 'properties:property_detail' object.pk %}{% else %}{% url 'properties:property_list' %}{% endif %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 
        {% if object %}Volver a Detalles{% else %}Volver a Lista{% endif %}
    </a>
</div>

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Información Básica -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Información Básica
                            </h4>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.property_type.id_for_label }}" class="form-label">
                                    <i class="bi bi-house"></i> {{ form.property_type.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.property_type }}
                                    <button type="button" class="btn btn-outline-success" id="add-property-type-btn" data-bs-toggle="modal" data-bs-target="#propertyTypeModal">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                {% if form.property_type.errors %}
                                    <div class="text-danger">{{ form.property_type.errors }}</div>
                                {% endif %}
                                <div class="form-text">Selecciona o crea un nuevo tipo</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.property_status.id_for_label }}" class="form-label">
                                    <i class="bi bi-flag"></i> {{ form.property_status.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.property_status }}
                                    <button type="button" class="btn btn-outline-success" id="add-property-status-btn" data-bs-toggle="modal" data-bs-target="#propertyStatusModal">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                {% if form.property_status.errors %}
                                    <div class="text-danger">{{ form.property_status.errors }}</div>
                                {% endif %}
                                <div class="form-text">Selecciona o crea un nuevo estado</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger">{{ form.description.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-geo-alt"></i> Ubicación
                            </h4>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.street.id_for_label }}" class="form-label">{{ form.street.label }}</label>
                                {{ form.street }}
                                {% if form.street.errors %}
                                    <div class="text-danger">{{ form.street.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.number.id_for_label }}" class="form-label">{{ form.number.label }}</label>
                                {{ form.number }}
                                {% if form.number.errors %}
                                    <div class="text-danger">{{ form.number.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.neighborhood.id_for_label }}" class="form-label">{{ form.neighborhood.label }}</label>
                                {{ form.neighborhood }}
                                {% if form.neighborhood.errors %}
                                    <div class="text-danger">{{ form.neighborhood.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.locality.id_for_label }}" class="form-label">{{ form.locality.label }}</label>
                                {{ form.locality }}
                                {% if form.locality.errors %}
                                    <div class="text-danger">{{ form.locality.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.province.id_for_label }}" class="form-label">{{ form.province.label }}</label>
                                {{ form.province }}
                                {% if form.province.errors %}
                                    <div class="text-danger">{{ form.province.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.country.id_for_label }}" class="form-label">{{ form.country.label }}</label>
                                {{ form.country }}
                                {% if form.country.errors %}
                                    <div class="text-danger">{{ form.country.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Características -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-house"></i> Características
                            </h4>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.total_surface.id_for_label }}" class="form-label">{{ form.total_surface.label }}</label>
                                {{ form.total_surface }}
                                {% if form.total_surface.errors %}
                                    <div class="text-danger">{{ form.total_surface.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.covered_surface.id_for_label }}" class="form-label">{{ form.covered_surface.label }}</label>
                                {{ form.covered_surface }}
                                {% if form.covered_surface.errors %}
                                    <div class="text-danger">{{ form.covered_surface.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.bedrooms.id_for_label }}" class="form-label">{{ form.bedrooms.label }}</label>
                                {{ form.bedrooms }}
                                {% if form.bedrooms.errors %}
                                    <div class="text-danger">{{ form.bedrooms.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.bathrooms.id_for_label }}" class="form-label">{{ form.bathrooms.label }}</label>
                                {{ form.bathrooms }}
                                {% if form.bathrooms.errors %}
                                    <div class="text-danger">{{ form.bathrooms.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.garage }}
                                    <label class="form-check-label" for="{{ form.garage.id_for_label }}">
                                        {{ form.garage.label }}
                                    </label>
                                </div>
                                {% if form.garage.errors %}
                                    <div class="text-danger">{{ form.garage.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.furnished }}
                                    <label class="form-check-label" for="{{ form.furnished.id_for_label }}">
                                        {{ form.furnished.label }}
                                    </label>
                                </div>
                                {% if form.furnished.errors %}
                                    <div class="text-danger">{{ form.furnished.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.year_built.id_for_label }}" class="form-label">{{ form.year_built.label }}</label>
                                {{ form.year_built }}
                                {% if form.year_built.errors %}
                                    <div class="text-danger">{{ form.year_built.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.orientation.id_for_label }}" class="form-label">{{ form.orientation.label }}</label>
                                {{ form.orientation }}
                                {% if form.orientation.errors %}
                                    <div class="text-danger">{{ form.orientation.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.floors.id_for_label }}" class="form-label">{{ form.floors.label }}</label>
                                {{ form.floors }}
                                {% if form.floors.errors %}
                                    <div class="text-danger">{{ form.floors.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Precios -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Precios
                            </h4>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.sale_price.id_for_label }}" class="form-label">{{ form.sale_price.label }}</label>
                                {{ form.sale_price }}
                                {% if form.sale_price.errors %}
                                    <div class="text-danger">{{ form.sale_price.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.rental_price.id_for_label }}" class="form-label">{{ form.rental_price.label }}</label>
                                {{ form.rental_price }}
                                {% if form.rental_price.errors %}
                                    <div class="text-danger">{{ form.rental_price.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.expenses.id_for_label }}" class="form-label">{{ form.expenses.label }}</label>
                                {{ form.expenses }}
                                {% if form.expenses.errors %}
                                    <div class="text-danger">{{ form.expenses.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Agente Responsable -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-badge"></i> Agente Responsable
                            </h4>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.agent.id_for_label }}" class="form-label">
                                    <i class="bi bi-person"></i> {{ form.agent.label }}
                                </label>
                                {{ form.agent }}
                                {% if form.agent.errors %}
                                    <div class="text-danger">{{ form.agent.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    {% if not object %}
                                        Por defecto se asigna a ti como agente responsable. Puedes cambiarlo si es necesario.
                                    {% else %}
                                        Agente responsable de esta propiedad.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if user.is_staff or user.is_superuser %}
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Administrador:</strong> Puedes asignar esta propiedad a cualquier agente activo.
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Características Adicionales -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-tags"></i> Características y Etiquetas
                            </h4>
                        </div>
                        
                        <!-- Features existentes -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-star"></i> {{ form.features.label }}
                                </label>
                                <div class="features-container border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {{ form.features }}
                                </div>
                                {% if form.features.errors %}
                                    <div class="text-danger">{{ form.features.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Campo para nuevas features -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-plus-circle"></i> {{ form.new_features.label }}
                                </label>
                                {{ form.new_features }}
                                {% if form.new_features.errors %}
                                    <div class="text-danger">{{ form.new_features.errors }}</div>
                                {% endif %}
                                <div class="form-text">{{ form.new_features.help_text }}</div>
                                
                                <!-- Vista previa de nuevas features -->
                                <div id="new-features-preview" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- Tags existentes -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-tags"></i> {{ form.tags.label }}
                                </label>
                                <div class="tags-container border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {{ form.tags }}
                                </div>
                                {% if form.tags.errors %}
                                    <div class="text-danger">{{ form.tags.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Campo para nuevos tags -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-plus-circle"></i> {{ form.new_tags.label }}
                                </label>
                                {{ form.new_tags }}
                                {% if form.new_tags.errors %}
                                    <div class="text-danger">{{ form.new_tags.errors }}</div>
                                {% endif %}
                                <div class="form-text">{{ form.new_tags.help_text }}</div>
                                
                                <!-- Vista previa de nuevos tags -->
                                <div id="new-tags-preview" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- Información adicional -->
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Consejo:</strong> 
                                Las características seleccionadas se aplicarán a la propiedad. 
                                Si escribes nuevas características o etiquetas, se crearán automáticamente y se asignarán a esta propiedad.
                            </div>
                        </div>
                    </div>

                    <!-- Imágenes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Imágenes de la Propiedad
                            </h4>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Tip:</strong> Puedes agregar hasta 10 imágenes. La primera imagen marcada como "Portada" se mostrará en las listas.
                            </div>
                            
                            <div id="image-formset">
                                {{ image_formset.management_form }}
                                
                                <!-- Plantilla para nuevos formularios de imagen -->
                                <div id="empty-form" style="display: none;">
                                    <div class="image-form-container card mb-3">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-4">
                                                    <div class="image-preview-container">
                                                        <div class="image-preview bg-light d-flex align-items-center justify-content-center" style="height: 150px; border: 2px dashed #ccc;">
                                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="row">
                                                        <div class="col-md-12 mb-3">
                                                            {{ image_formset.empty_form.image.label_tag }}
                                                            {{ image_formset.empty_form.image }}
                                                        </div>
                                                        <div class="col-md-8 mb-3">
                                                            {{ image_formset.empty_form.description.label_tag }}
                                                            {{ image_formset.empty_form.description }}
                                                        </div>
                                                        <div class="col-md-4 mb-3">
                                                            <div class="form-check">
                                                                {{ image_formset.empty_form.is_cover }}
                                                                {{ image_formset.empty_form.is_cover.label_tag }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-danger remove-image-form">
                                                        <i class="bi bi-trash"></i> Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Formularios existentes -->
                                <div id="image-forms-container">
                                    {% for form in image_formset %}
                                    <div class="image-form-container card mb-3">
                                        <div class="card-body">
                                            {% if form.instance.pk %}
                                                {{ form.DELETE }}
                                                {{ form.id }}
                                            {% endif %}
                                            
                                            <div class="row align-items-center">
                                                <div class="col-md-4">
                                                    <div class="image-preview-container">
                                                        {% if form.instance.image %}
                                                            <div class="image-preview">
                                                                <img src="{{ form.instance.image.url }}" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" alt="Vista previa">
                                                            </div>
                                                        {% else %}
                                                            <div class="image-preview bg-light d-flex align-items-center justify-content-center" style="height: 150px; border: 2px dashed #ccc;">
                                                                <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="row">
                                                        <div class="col-md-12 mb-3">
                                                            {{ form.image.label_tag }}
                                                            {{ form.image }}
                                                            {% if form.image.errors %}
                                                                <div class="text-danger">{{ form.image.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-8 mb-3">
                                                            {{ form.description.label_tag }}
                                                            {{ form.description }}
                                                            {% if form.description.errors %}
                                                                <div class="text-danger">{{ form.description.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-4 mb-3">
                                                            <div class="form-check">
                                                                {{ form.is_cover }}
                                                                {{ form.is_cover.label_tag }}
                                                                {% if form.is_cover.errors %}
                                                                    <div class="text-danger">{{ form.is_cover.errors }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% if form.instance.pk %}
                                                        <button type="button" class="btn btn-sm btn-danger mark-for-deletion">
                                                            <i class="bi bi-trash"></i> Marcar para eliminar
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-sm btn-danger remove-image-form">
                                                            <i class="bi bi-trash"></i> Eliminar
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <button type="button" id="add-image-form" class="btn btn-success mb-3">
                                    <i class="bi bi-plus-circle"></i> Agregar Nueva Imagen
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{% if object %}{% url 'properties:property_detail' object.pk %}{% else %}{% url 'properties:property_list' %}{% endif %}" class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> 
                                    {% if object %}Actualizar{% else %}Crear{% endif %} Propiedad
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear Property Type -->
<div class="modal fade" id="propertyTypeModal" tabindex="-1" aria-labelledby="propertyTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="propertyTypeModalLabel">
                    <i class="bi bi-house"></i> Crear Nuevo Tipo de Propiedad
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="propertyTypeForm">
                    <div class="mb-3">
                        <label for="propertyTypeName" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="propertyTypeName" placeholder="Ej: Casa, Departamento, Local" required>
                    </div>
                    <div class="mb-3">
                        <label for="propertyTypeDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="propertyTypeDescription" rows="3" placeholder="Descripción opcional del tipo de propiedad"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="savePropertyType">
                    <i class="bi bi-check"></i> Crear Tipo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear Property Status -->
<div class="modal fade" id="propertyStatusModal" tabindex="-1" aria-labelledby="propertyStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="propertyStatusModalLabel">
                    <i class="bi bi-flag"></i> Crear Nuevo Estado de Propiedad
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="propertyStatusForm">
                    <div class="mb-3">
                        <label for="propertyStatusName" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="propertyStatusName" placeholder="Ej: Disponible, Vendida, Alquilada" required>
                    </div>
                    <div class="mb-3">
                        <label for="propertyStatusDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="propertyStatusDescription" rows="3" placeholder="Descripción opcional del estado"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="savePropertyStatus">
                    <i class="bi bi-check"></i> Crear Estado
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-image-form');
    const emptyForm = document.getElementById('empty-form');
    const formsContainer = document.getElementById('image-forms-container');
    const totalFormsInput = document.querySelector('#id_images-TOTAL_FORMS');
    
    let formNum = parseInt(totalFormsInput.value);
    
    // Agregar nueva imagen
    addButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (formNum >= 10) {
            alert('Máximo 10 imágenes por propiedad');
            return;
        }
        
        const newForm = emptyForm.innerHTML.replace(/__prefix__/g, formNum);
        const formWrapper = document.createElement('div');
        formWrapper.innerHTML = newForm;
        
        formsContainer.appendChild(formWrapper.firstElementChild);
        
        formNum++;
        totalFormsInput.value = formNum;
        
        // Agregar eventos al nuevo formulario
        addFormEvents(formWrapper.firstElementChild);
    });
    
    // Función para agregar eventos a un formulario
    function addFormEvents(formElement) {
        // Vista previa de imagen
        const imageInput = formElement.querySelector('input[type="file"]');
        const previewContainer = formElement.querySelector('.image-preview');
        
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" alt="Vista previa">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.innerHTML = '<i class="bi bi-image text-muted" style="font-size: 2rem;"></i>';
                }
            });
        }
        
        // Botón eliminar
        const removeButton = formElement.querySelector('.remove-image-form');
        if (removeButton) {
            removeButton.addEventListener('click', function(e) {
                e.preventDefault();
                formElement.remove();
                
                // Actualizar numeración de formularios
                updateFormIndexes();
            });
        }
        
        // Botón marcar para eliminación (para imágenes existentes)
        const markDeleteButton = formElement.querySelector('.mark-for-deletion');
        if (markDeleteButton) {
            markDeleteButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const deleteInput = formElement.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = !deleteInput.checked;
                    
                    if (deleteInput.checked) {
                        formElement.style.opacity = '0.5';
                        markDeleteButton.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Restaurar';
                        markDeleteButton.classList.remove('btn-danger');
                        markDeleteButton.classList.add('btn-warning');
                    } else {
                        formElement.style.opacity = '1';
                        markDeleteButton.innerHTML = '<i class="bi bi-trash"></i> Marcar para eliminar';
                        markDeleteButton.classList.remove('btn-warning');
                        markDeleteButton.classList.add('btn-danger');
                    }
                }
            });
        }
    }
    
    // Función para actualizar índices de formularios
    function updateFormIndexes() {
        const forms = formsContainer.querySelectorAll('.image-form-container');
        
        forms.forEach((form, index) => {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name) {
                    input.name = input.name.replace(/images-\d+/, `images-${index}`);
                }
                if (input.id) {
                    input.id = input.id.replace(/id_images-\d+/, `id_images-${index}`);
                }
            });
            
            const labels = form.querySelectorAll('label');
            labels.forEach(label => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', label.getAttribute('for').replace(/id_images-\d+/, `id_images-${index}`));
                }
            });
        });
        
        totalFormsInput.value = forms.length;
    }
    
    // Agregar eventos a formularios existentes
    document.querySelectorAll('.image-form-container').forEach(form => {
        addFormEvents(form);
    });
    
    // Solo una imagen de portada
    document.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.includes('is_cover') && e.target.checked) {
            // Desmarcar otras imágenes de portada
            document.querySelectorAll('input[name*="is_cover"]').forEach(checkbox => {
                if (checkbox !== e.target) {
                    checkbox.checked = false;
                }
            });
        }
    });
    
    // Validación antes de enviar
    document.querySelector('form').addEventListener('submit', function(e) {
        const imageInputs = document.querySelectorAll('input[type="file"][name*="image"]');
        let hasImages = false;
        
        imageInputs.forEach(input => {
            if (input.files.length > 0) {
                hasImages = true;
            }
        });
        
        // También verificar imágenes existentes no marcadas para eliminación
        const existingImages = document.querySelectorAll('input[name*="-DELETE"]');
        existingImages.forEach(deleteInput => {
            if (!deleteInput.checked) {
                hasImages = true;
            }
        });
        
        if (!hasImages) {
            const confirm = window.confirm('No has agregado ninguna imagen. ¿Deseas continuar sin imágenes?');
            if (!confirm) {
                e.preventDefault();
            }
        }
    });
    
    // =====================================
    // Gestión de Features y Tags
    // =====================================
    
    // Vista previa de nuevas features
    const newFeaturesInput = document.getElementById('id_new_features');
    const featuresPreview = document.getElementById('new-features-preview');
    
    if (newFeaturesInput) {
        newFeaturesInput.addEventListener('input', function() {
            const text = this.value.trim();
            if (text) {
                const features = text.split(',').map(f => f.trim()).filter(f => f);
                let previewHTML = '<div class="mb-2"><small class="text-muted">Vista previa:</small></div>';
                
                features.forEach(feature => {
                    previewHTML += `<span class="badge bg-info me-1 mb-1">${feature.trim()}</span>`;
                });
                
                featuresPreview.innerHTML = previewHTML;
            } else {
                featuresPreview.innerHTML = '';
            }
        });
    }
    
    // Vista previa de nuevos tags
    const newTagsInput = document.getElementById('id_new_tags');
    const tagsPreview = document.getElementById('new-tags-preview');
    const tagColors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#6f42c1', '#fd7e14', '#20c997'];
    
    if (newTagsInput) {
        newTagsInput.addEventListener('input', function() {
            const text = this.value.trim();
            if (text) {
                const tags = text.split(',').map(t => t.trim()).filter(t => t);
                let previewHTML = '<div class="mb-2"><small class="text-muted">Vista previa:</small></div>';
                
                tags.forEach((tag, index) => {
                    const color = tagColors[index % tagColors.length];
                    previewHTML += `<span class="badge me-1 mb-1" style="background-color: ${color}">${tag.trim()}</span>`;
                });
                
                tagsPreview.innerHTML = previewHTML;
            } else {
                tagsPreview.innerHTML = '';
            }
        });
    }
    
    // Mejorar apariencia de checkboxes
    document.querySelectorAll('.features-container input[type="checkbox"]').forEach(checkbox => {
        const label = checkbox.parentElement;
        label.classList.add('form-check');
        checkbox.classList.add('form-check-input');
        
        const labelText = label.querySelector('label') || label;
        if (labelText.tagName !== 'LABEL') {
            labelText.classList.add('form-check-label');
        }
    });
    
    document.querySelectorAll('.tags-container input[type="checkbox"]').forEach(checkbox => {
        const label = checkbox.parentElement;
        label.classList.add('form-check');
        checkbox.classList.add('form-check-input');
        
        const labelText = label.querySelector('label') || label;
        if (labelText.tagName !== 'LABEL') {
            labelText.classList.add('form-check-label');
        }
        
        // Si es posible, obtener el color del tag y aplicarlo
        const tagName = labelText.textContent.trim();
        // Aquí podríamos hacer una consulta AJAX para obtener el color, pero por simplicidad lo omitimos
    });
    
    // Función para limpiar los campos de vista previa al enviar el formulario
    document.querySelector('form').addEventListener('submit', function() {
        // Las vistas previas se limpian para evitar confusión
        if (featuresPreview) featuresPreview.innerHTML = '';
        if (tagsPreview) tagsPreview.innerHTML = '';
    });
    
    // =====================================
    // Gestión de PropertyType y PropertyStatus
    // =====================================
    
    // Crear Property Type
    const savePropertyTypeBtn = document.getElementById('savePropertyType');
    if (savePropertyTypeBtn) {
        savePropertyTypeBtn.addEventListener('click', async function() {
            const name = document.getElementById('propertyTypeName').value.trim();
            const description = document.getElementById('propertyTypeDescription').value.trim();
            
            if (!name) {
                alert('Por favor, ingresa un nombre para el tipo de propiedad.');
                return;
            }
            
            try {
                const response = await fetch('{% url "properties:create_property_type_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Agregar al select
                    const propertyTypeSelect = document.getElementById('id_property_type');
                    const newOption = new Option(data.property_type.name, data.property_type.id, true, true);
                    propertyTypeSelect.add(newOption);
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('propertyTypeModal'));
                    modal.hide();
                    
                    // Limpiar formulario
                    document.getElementById('propertyTypeForm').reset();
                    
                    // Mostrar mensaje
                    if (data.created) {
                        showToast('Tipo de propiedad creado correctamente', 'success');
                    } else {
                        showToast('Tipo de propiedad ya existía, se ha seleccionado', 'info');
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear el tipo de propiedad');
            }
        });
    }
    
    // Crear Property Status
    const savePropertyStatusBtn = document.getElementById('savePropertyStatus');
    if (savePropertyStatusBtn) {
        savePropertyStatusBtn.addEventListener('click', async function() {
            const name = document.getElementById('propertyStatusName').value.trim();
            const description = document.getElementById('propertyStatusDescription').value.trim();
            
            if (!name) {
                alert('Por favor, ingresa un nombre para el estado de propiedad.');
                return;
            }
            
            try {
                const response = await fetch('{% url "properties:create_property_status_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Agregar al select
                    const propertyStatusSelect = document.getElementById('id_property_status');
                    const newOption = new Option(data.property_status.name, data.property_status.id, true, true);
                    propertyStatusSelect.add(newOption);
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('propertyStatusModal'));
                    modal.hide();
                    
                    // Limpiar formulario
                    document.getElementById('propertyStatusForm').reset();
                    
                    // Mostrar mensaje
                    if (data.created) {
                        showToast('Estado de propiedad creado correctamente', 'success');
                    } else {
                        showToast('Estado de propiedad ya existía, se ha seleccionado', 'info');
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear el estado de propiedad');
            }
        });
    }
    
    // Función para mostrar toasts
    function showToast(message, type = 'info') {
        // Crear toast dinámicamente
        const toastContainer = document.querySelector('.toast-container') || createToastContainer();
        
        const toastId = 'toast-' + Date.now();
        const toastHTML = `
            <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi bi-${type === 'success' ? 'check-circle text-success' : 'info-circle text-info'} me-2"></i>
                    <strong class="me-auto">Notificación</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remover después de que se oculte
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
        return container;
    }
});
</script>

<!-- Estilos adicionales para Features y Tags -->
<style>
.features-container .form-check,
.tags-container .form-check {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s ease;
}

.features-container .form-check:hover,
.tags-container .form-check:hover {
    background-color: #f8f9fa;
}

.features-container .form-check-input:checked + .form-check-label,
.tags-container .form-check-input:checked + .form-check-label {
    font-weight: 600;
    color: #0d6efd;
}

#new-features-preview .badge,
#new-tags-preview .badge {
    font-size: 0.875em;
}

.alert-info {
    border-left: 4px solid #0dcaf0;
}
</style>
{% endblock %}
