{% extends 'base.html' %}
{% block page_title %}Detalle de Factura{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb breadcrumb-modern">
            <li class="breadcrumb-item">
                <a href="{% url 'accounting:accounting_dashboard' %}" class="text-decoration-none">
                    <i class="bi bi-calculator me-1"></i>Contabilidad
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'accounting:invoice_list' %}" class="text-decoration-none">
                    Facturas
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Factura #{{ invoice.number|default:invoice.id }}
            </li>
        </ol>
    </nav>

    <div class="row g-lg-4 g-md-3 g-2">
        <!-- Columna Principal -->
        <div class="col-lg-7 col-md-12">
            <!-- Información General -->
            <div class="card card-modern mb-4">
                <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center py-3">
                    <h2 class="h4 mb-0 text-dark fw-bold">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        Factura #{{ invoice.number|default:invoice.id }}
                    </h2>
                    <div class="btn-group" role="group">
                        <a href="{% url 'accounting:invoice_update' invoice.pk %}"
                            class="btn btn-warning btn-sm btn-modern">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </a>
                        <a href="{% url 'accounting:invoice_delete' invoice.pk %}"
                            class="btn btn-danger btn-sm btn-modern">
                            <i class="bi bi-trash me-1"></i>Eliminar
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-person-circle text-primary me-2 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">Cliente</small>
                                    <strong>{{ invoice.customer.get_full_name }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">Fecha de emisión</small>
                                    <strong>{{ invoice.date|date:'d/m/Y' }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-calendar-x text-primary me-2 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">Vencimiento</small>
                                    <strong>{{ invoice.due_date|date:'d/m/Y' }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-flag text-primary me-2 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">Estado</small>
                                    <span class="badge rounded-pill
                                        {% if invoice.status == 'paid' %}bg-success
                                        {% elif invoice.status == 'sent' %}bg-info
                                        {% elif invoice.status == 'validated' %}bg-warning text-dark
                                        {% elif invoice.status == 'cancelled' %}bg-danger
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ invoice.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% if invoice.description %}
                        <div class="col-12">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-card-text text-primary me-2 fs-5 mt-1"></i>
                                <div>
                                    <small class="text-muted d-block">Descripción</small>
                                    <p class="mb-0">{{ invoice.description }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-currency-dollar text-success me-2 fs-4"></i>
                                <div>
                                    <small class="text-muted d-block">Total</small>
                                    <h4 class="text-success mb-0">${{ invoice.total_amount|floatformat:2 }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ítems de la Factura -->
            <div class="card card-modern mb-4">
                <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="bi bi-list-ul me-2"></i>Ítems de la Factura
                    </h5>
                    <button type="button" class="btn btn-primary btn-sm btn-modern" data-bs-toggle="modal"
                        data-bs-target="#addItemModal">
                        <i class="bi bi-plus-circle me-1"></i>Agregar Ítem
                    </button>
                </div>
                <div class="card-body p-0">
                    {% if invoice.lines.all %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 ps-4">Concepto</th>
                                    <th class="border-0 text-end">Monto</th>
                                    <th class="border-0 text-center pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in invoice.lines.all %}
                                <tr>
                                    <td class="ps-4 align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-dot text-primary me-2 fs-4"></i>
                                            <span>{{ item.concept }}</span>
                                        </div>
                                    </td>
                                    <td class="text-end align-middle">
                                        <span class="fw-bold text-success">${{ item.amount|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-center align-middle pe-4">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'accounting:invoiceline_update' item.pk %}"
                                                class="btn btn-outline-warning btn-modern" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{% url 'accounting:invoiceline_delete' item.pk %}"
                                                class="btn btn-outline-danger btn-modern" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No hay ítems registrados en esta factura.</p>
                        <small class="text-muted">Agregue ítems para completar la factura.</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pagos -->
            <div class="card card-modern mb-4">
                <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="bi bi-credit-card me-2"></i>Historial de Pagos
                    </h5>
                    <div class="btn-group" role="group">
                        <a href="{% url 'accounting:payment_create' invoice.pk %}"
                            class="btn btn-success btn-sm btn-modern">
                            <i class="bi bi-plus-circle me-1"></i>Registrar Pago
                        </a>
                        <button type="button" class="btn btn-outline-success btn-sm btn-modern" data-bs-toggle="modal"
                            data-bs-target="#quickPaymentModal">
                            <i class="bi bi-lightning me-1"></i>Pago Rápido
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if invoice.payments.all %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 ps-4">Fecha</th>
                                    <th class="border-0">Método</th>
                                    <th class="border-0 text-end">Monto</th>
                                    <th class="border-0">Notas</th>
                                    <th class="border-0 text-center pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in invoice.payments.all %}
                                <tr>
                                    <td class="ps-4 align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-check text-success me-2"></i>
                                            <span>{{ payment.date|date:'d/m/Y' }}</span>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <span class="badge bg-light text-dark rounded-pill">{{ payment.method }}</span>
                                    </td>
                                    <td class="text-end align-middle">
                                        <span class="fw-bold text-success">${{ payment.amount|floatformat:2 }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <span class="text-muted">{{ payment.notes|default:'-' }}</span>
                                    </td>
                                    <td class="text-center align-middle pe-4">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'accounting:payment_update' payment.pk %}"
                                                class="btn btn-outline-warning btn-modern" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{% url 'accounting:payment_delete' payment.pk %}"
                                                class="btn btn-outline-danger btn-modern" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumen de Pagos -->
                    <div class="card-footer bg-light">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-currency-dollar text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Total Pagado</small>
                                        <strong class="text-success">${{ total_paid|floatformat:2 }}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Saldo Pendiente</small>
                                        <strong
                                            class="{% if balance <= 0 %}text-success{% else %}text-warning{% endif %}">
                                            ${{ balance|floatformat:2 }}
                                        </strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-receipt text-info me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Total Factura</small>
                                        <strong class="text-info">${{ invoice.total_amount|floatformat:2 }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-credit-card text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No hay pagos registrados para esta factura.</p>
                        <small class="text-muted">Registre un pago para actualizar el estado de la factura.</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comprobantes de Propietario -->
            {% if invoice.contract %}
            <div class="card card-modern mb-4">
                <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="bi bi-file-earmark-check me-2"></i>Comprobantes de Propietario
                    </h5>
                    {% if invoice.status in 'validated,sent,paid' %}
                    <button type="button" class="btn btn-warning btn-sm btn-modern" data-invoice-id="{{ invoice.pk }}"
                        data-invoice-number="{{ invoice.number|default:invoice.id }}"
                        data-has-receipt="{% if invoice.owner_receipts.exists %}true{% else %}false{% endif %}"
                        onclick="showOwnerReceiptModal(this.dataset.invoiceId, this.dataset.invoiceNumber, this.dataset.hasReceipt === 'true')">
                        <i
                            class="bi bi-{% if invoice.owner_receipts.exists %}file-check{% else %}file-plus{% endif %} me-1"></i>
                        {% if invoice.owner_receipts.exists %}Ver Comprobantes{% else %}Generar Comprobante{% endif %}
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-4">
                    {% if invoice.owner_receipts.exists %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Número</th>
                                    <th scope="col">Generado</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Monto Neto</th>
                                    <th scope="col" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for receipt in invoice.owner_receipts.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-check text-warning me-2"></i>
                                            <span class="fw-semibold">{{ receipt.receipt_number }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="fw-semibold">{{ receipt.generated_at|date:'d/m/Y H:i' }}</div>
                                            <small class="text-muted">por {{ receipt.generated_by.get_full_name}}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge rounded-pill
                                                {% if receipt.status == 'sent' %}bg-success
                                                {% elif receipt.status == 'failed' %}bg-danger
                                                {% else %}bg-warning text-dark
                                                {% endif %}">
                                            {{ receipt.get_status_display }}
                                        </span>
                                        {% if receipt.sent_at %}
                                        <br><small class="text-muted">{{ receipt.sent_at|date:'d/m/Y H:i' }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <span class="fw-bold text-success">${{ receipt.net_amount|floatformat:2}}</span>
                                            {% if receipt.discount_percentage %}
                                            <br><small class="text-muted">
                                                Descuento: {{ receipt.discount_percentage }}%
                                                (-${{ receipt.discount_amount|floatformat:2 }})
                                            </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'accounting:owner_receipt_detail' receipt.pk %}"
                                                class="btn btn-sm btn-outline-primary btn-modern" title="Ver detalle">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'accounting:owner_receipt_pdf' receipt.pk %}"
                                                class="btn btn-sm btn-outline-success btn-modern" title="Descargar PDF">
                                                <i class="bi bi-file-earmark-pdf"></i>
                                            </a>
                                            {% if receipt.status == 'failed' %}
                                            <button type="button" class="btn btn-sm btn-outline-warning btn-modern"
                                                onclick="resendOwnerReceipt({{ receipt.pk }})" title="Reenviar">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-plus text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-1">No hay comprobantes generados para esta factura.</p>
                        <small class="text-muted">Los comprobantes proporcionan transparencia al propietario sobre los
                            cálculos de alquiler.</small>
                        {% if invoice.status in 'validated,sent,paid' %}
                        <div class="mt-3">
                            <button type="button" class="btn btn-warning btn-modern" data-invoice-id="{{ invoice.pk }}"
                                data-invoice-number="{{ invoice.number|default:invoice.id }}" data-has-receipt="false"
                                onclick="showOwnerReceiptModal(this.dataset.invoiceId, this.dataset.invoiceNumber, this.dataset.hasReceipt === 'true')">
                                <i class="bi bi-file-plus me-2"></i>Generar Primer Comprobante
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Acciones -->
            <div class="card card-modern mb-4">
                <div class="card-body p-4">
                    <div class="d-flex flex-wrap gap-3 justify-content-center">
                        <a href="{% url 'accounting:invoice_pdf' invoice.pk %}" class="btn btn-info btn-modern">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Descargar PDF
                        </a>
                        {% if invoice.status == 'validated' or invoice.status == 'sent' %}
                        <a href="{% url 'accounting:send_invoice_email' invoice.pk %}"
                            class="btn btn-primary btn-modern">
                            <i class="bi bi-envelope me-2"></i>Enviar por Correo
                        </a>
                        {% endif %}
                        {% if invoice.status != 'cancelled' and invoice.status != 'paid' %}
                        <a href="{% url 'accounting:invoice_cancel' invoice.pk %}"
                            class="btn btn-outline-danger btn-modern">
                            <i class="bi bi-x-circle me-2"></i>Cancelar Factura
                        </a>
                        {% endif %}
                        <a href="{% url 'accounting:invoice_list' %}" class="btn btn-secondary btn-modern">
                            <i class="bi bi-arrow-left me-2"></i>Volver a la lista
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna de Vista Previa -->
        <div class="col-lg-5 col-md-12">
            <div class="card card-modern sticky-top" style="top: 20px;">
                <div class="card-header bg-light border-bottom py-3">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="bi bi-eye-fill me-2"></i>Vista Previa de Factura
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <h4 class="text-primary mb-0">FACTURA</h4>
                        <span class="badge rounded-pill
                            {% if invoice.status == 'paid' %}bg-success
                            {% elif invoice.status == 'sent' %}bg-info
                            {% elif invoice.status == 'validated' %}bg-warning text-dark
                            {% elif invoice.status == 'cancelled' %}bg-danger
                            {% else %}bg-secondary
                            {% endif %}">
                            {{ invoice.get_status_display }}
                        </span>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <p class="mb-1 small text-muted">NÚMERO:</p>
                            <p class="fw-bold">{{ invoice.number|default:invoice.id }}</p>
                        </div>
                        <div class="col-6 text-end">
                            <p class="mb-1 small text-muted">FECHA:</p>
                            <p class="fw-bold">{{ invoice.date|date:'d/m/Y' }}</p>
                            <p class="mb-1 small text-muted">VENCIMIENTO:</p>
                            <p class="fw-bold">{{ invoice.due_date|date:'d/m/Y' }}</p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <p class="mb-1 small text-muted">CLIENTE:</p>
                        <p class="fw-bold">{{ invoice.customer.get_full_name }}</p>
                        {% if invoice.customer.email %}
                        <p class="small text-muted">{{ invoice.customer.email }}</p>
                        {% endif %}
                    </div>

                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if invoice.lines.all %}
                                {% for line in invoice.lines.all %}
                                <tr>
                                    <td>{{ line.concept }}</td>
                                    <td class="text-end">${{ line.amount|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">
                                        No hay ítems agregados.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Subtotal:</span>
                                <span>${{ invoice.total_amount|floatformat:2 }}</span>
                            </div>
                            <hr class="my-1">
                            <div class="d-flex justify-content-between fw-bold h5 mt-2">
                                <span>TOTAL:</span>
                                <span class="text-success">${{ invoice.total_amount|floatformat:2 }}</span>
                            </div>
                            {% if total_paid > 0 %}
                            <div class="d-flex justify-content-between text-success">
                                <span>Pagado:</span>
                                <span>-${{ total_paid|floatformat:2 }}</span>
                            </div>
                            <hr class="my-1">
                            <div class="d-flex justify-content-between fw-bold">
                                <span>SALDO:</span>
                                <span class="{% if balance <= 0 %}text-success{% else %}text-warning{% endif %}">
                                    ${{ balance|floatformat:2 }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if invoice.description %}
                    <div class="mt-3 small text-muted">
                        <p class="mb-1"><strong>Descripción:</strong></p>
                        <p>{{ invoice.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Ítem -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Agregar Ítem a la Factura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addItemForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="itemConcept" class="form-label">Concepto</label>
                        <input type="text" class="form-control" id="itemConcept" name="concept" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="itemAmount" class="form-label">Monto</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="itemAmount" name="amount" step="0.01" min="0"
                                required>
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Agregar Ítem
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Pago Rápido -->
<div class="modal fade" id="quickPaymentModal" tabindex="-1" aria-labelledby="quickPaymentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickPaymentModalLabel">
                    <i class="bi bi-lightning me-2"></i>Pago Rápido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="quickPaymentForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Monto</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01"
                                min="0" value="{{ balance|floatformat:2 }}" required>
                        </div>
                        <small class="form-text text-muted">Saldo pendiente: ${{ balance|floatformat:2 }}</small>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Método de Pago</label>
                        <select class="form-select" id="paymentMethod" name="method" required>
                            <option value="">Seleccione un método</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                            <option value="Tarjeta de Débito">Tarjeta de Débito</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>Registrar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar CSRF token para todas las peticiones AJAX
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Función para mostrar mensajes de error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const feedback = field.parentNode.querySelector('.invalid-feedback');
            field.classList.add('is-invalid');
            if (feedback) {
                feedback.textContent = message;
            }
        }

        // Función para limpiar errores
        function clearFieldErrors() {
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
        }

        // Función para mostrar toast de éxito
        function showSuccessToast(message) {
            // Crear toast dinámicamente si no existe
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            const toastHtml = `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <strong class="me-auto">Éxito</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();

            // Remover el toast después de que se oculte
            toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        // Manejar formulario de agregar ítem
        const addItemForm = document.getElementById('addItemForm');
        const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));

        addItemForm.addEventListener('submit', function (e) {
            e.preventDefault();
            clearFieldErrors();

            const formData = new FormData(addItemForm);
            formData.append('csrfmiddlewaretoken', csrfToken);

            const submitBtn = addItemForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Agregando...';
            submitBtn.disabled = true;

            fetch('{% url "accounting:invoiceline_create" invoice.pk %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addItemModal.hide();
                        showSuccessToast('Ítem agregado correctamente');
                        // Recargar la página para mostrar el nuevo ítem
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Mostrar errores de validación
                        if (data.errors) {
                            Object.keys(data.errors).forEach(field => {
                                const fieldId = field === 'concept' ? 'itemConcept' : 'itemAmount';
                                showFieldError(fieldId, data.errors[field][0]);
                            });
                        } else {
                            showFieldError('itemConcept', data.error || 'Error al agregar el ítem');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFieldError('itemConcept', 'Error de conexión. Inténtelo de nuevo.');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Limpiar formulario cuando se cierra el modal
        document.getElementById('addItemModal').addEventListener('hidden.bs.modal', function () {
            addItemForm.reset();
            clearFieldErrors();
        });

        // Manejar formulario de pago rápido
        const quickPaymentForm = document.getElementById('quickPaymentForm');
        const quickPaymentModal = new bootstrap.Modal(document.getElementById('quickPaymentModal'));

        quickPaymentForm.addEventListener('submit', function (e) {
            e.preventDefault();
            clearFieldErrors();

            const formData = new FormData(quickPaymentForm);
            formData.append('csrfmiddlewaretoken', csrfToken);

            const submitBtn = quickPaymentForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Registrando...';
            submitBtn.disabled = true;

            fetch('{% url "accounting:quick_payment_create" invoice.pk %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        quickPaymentModal.hide();
                        showSuccessToast('Pago registrado correctamente');
                        // Recargar la página para mostrar el nuevo pago
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Mostrar errores de validación
                        if (data.errors) {
                            Object.keys(data.errors).forEach(field => {
                                const fieldId = field === 'amount' ? 'paymentAmount' : 'paymentMethod';
                                showFieldError(fieldId, data.errors[field][0]);
                            });
                        } else {
                            showFieldError('paymentAmount', data.error || 'Error al registrar el pago');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFieldError('paymentAmount', 'Error de conexión. Inténtelo de nuevo.');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Limpiar formulario cuando se cierra el modal
        document.getElementById('quickPaymentModal').addEventListener('hidden.bs.modal', function () {
            quickPaymentForm.reset();
            clearFieldErrors();
            // Restaurar el valor del saldo pendiente
            document.getElementById('paymentAmount').value = '{{ balance|floatformat:2 }}';
        });
    });

    // Función para mostrar el modal de comprobante de propietario
    function showOwnerReceiptModal(invoiceId, invoiceNumber, hasReceipt) {
        const modal = new bootstrap.Modal(document.getElementById('ownerReceiptModal'));
        const modalTitle = document.getElementById('ownerReceiptModalLabel');
        const modalBody = document.getElementById('ownerReceiptModalBody');
        const generateBtn = document.getElementById('generateOwnerReceiptBtn');
        const previewBtn = document.getElementById('previewOwnerReceiptBtn');

        if (hasReceipt) {
            modalTitle.textContent = `Comprobante de Propietario - Factura ${invoiceNumber}`;
            modalBody.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Ya existe un comprobante generado para esta factura.
            </div>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-outline-warning" onclick="regenerateOwnerReceipt(${invoiceId})">
                    <i class="bi bi-arrow-clockwise me-2"></i>Regenerar Comprobante
                </button>
            </div>
        `;
            generateBtn.style.display = 'none';
            previewBtn.style.display = 'none';
        } else {
            modalTitle.textContent = `Generar Comprobante de Propietario - Factura ${invoiceNumber}`;
            modalBody.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Se generará un comprobante detallado para el propietario con información del alquiler y descuentos aplicados.
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="sendEmailCheck" checked>
                <label class="form-check-label" for="sendEmailCheck">
                    Enviar automáticamente por correo electrónico al propietario
                </label>
            </div>
        `;
            generateBtn.style.display = 'inline-block';
            previewBtn.style.display = 'inline-block';
            generateBtn.onclick = () => generateOwnerReceipt(invoiceId);
            previewBtn.onclick = () => previewOwnerReceipt(invoiceId);
        }

        modal.show();
    }

    // Función para generar comprobante de propietario
    function generateOwnerReceipt(invoiceId) {
        const sendEmail = document.getElementById('sendEmailCheck')?.checked || false;
        const btn = document.getElementById('generateOwnerReceiptBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generando...';

        fetch(`{% url 'accounting:generate_owner_receipt' 0 %}`.replace('0', invoiceId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `send_email=${sendEmail}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `Comprobante ${data.receipt_number} generado exitosamente.`);
                    bootstrap.Modal.getInstance(document.getElementById('ownerReceiptModal')).hide();
                    // Actualizar la página para mostrar el nuevo comprobante
                    location.reload();
                } else {
                    showAlert('danger', `Error: ${data.error}`);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error al generar el comprobante. Intente nuevamente.');
                console.error('Error:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    // Función para previsualizar comprobante
    function previewOwnerReceipt(invoiceId) {
        window.open(`/accounting/invoice/${invoiceId}/preview-owner-receipt/`, '_blank');
    }

    // Función para regenerar comprobante
    function regenerateOwnerReceipt(invoiceId) {
        if (confirm('¿Está seguro de que desea regenerar el comprobante? Esto creará un nuevo comprobante.')) {
            generateOwnerReceipt(invoiceId);
        }
    }

    // Función para reenviar comprobante
    function resendOwnerReceipt(receiptId) {
        if (confirm('¿Desea reenviar este comprobante por correo electrónico?')) {
            fetch(`/accounting/owner-receipt/${receiptId}/resend/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', 'Comprobante reenviado exitosamente.');
                        location.reload();
                    } else {
                        showAlert('danger', `Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    showAlert('danger', 'Error al reenviar el comprobante.');
                    console.error('Error:', error);
                });
        }
    }

    // Función para mostrar alertas
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>

<!-- Modal para Comprobante de Propietario -->
<div class="modal fade" id="ownerReceiptModal" tabindex="-1" aria-labelledby="ownerReceiptModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ownerReceiptModalLabel">Comprobante de Propietario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="ownerReceiptModalBody">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="previewOwnerReceiptBtn">
                    <i class="bi bi-eye me-2"></i>Vista Previa
                </button>
                <button type="button" class="btn btn-warning" id="generateOwnerReceiptBtn">
                    <i class="bi bi-file-plus me-2"></i>Generar Comprobante
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}