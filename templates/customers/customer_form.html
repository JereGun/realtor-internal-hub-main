{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}
        Editar Cliente - {{ object.get_full_name }}
    {% else %}
        Nuevo Cliente
    {% endif %}
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    .form-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f3f4f6;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.25rem;
        color: white;
    }
    
    .section-icon.personal { background: #2563eb; }
    .section-icon.address { background: #059669; }
    .section-icon.additional { background: #d97706; }
    
    .form-floating-custom {
        position: relative;
    }
    
    .form-floating-custom .form-control:focus,
    .form-floating-custom .form-control:not(:placeholder-shown) {
        padding-top: 1.625rem;
        padding-bottom: 0.625rem;
    }
    
    .form-floating-custom .form-control:focus ~ label,
    .form-floating-custom .form-control:not(:placeholder-shown) ~ label {
        opacity: 0.65;
        transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    }
    
    .btn-action {
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.3);
    }
    
    .progress-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 1rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .progress-step.active {
        background: #2563eb;
        color: white;
    }
    
    .progress-step.completed {
        background: #059669;
        color: white;
    }
    
    .progress-step.pending {
        background: #e5e7eb;
        color: #6b7280;
    }
    
    .progress-line {
        width: 60px;
        height: 2px;
        background: #e5e7eb;
        margin-top: 19px;
    }
    
    .progress-line.completed {
        background: #059669;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'customers:customer_list' %}" class="text-decoration-none">
                            <i class="bi bi-people me-1"></i>Clientes
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {% if object %}Editar Cliente{% else %}Nuevo Cliente{% endif %}
                    </li>
                </ol>
            </nav>
            <h1 class="h3 text-dark mb-1">
                {% if object %}
                    <i class="bi bi-pencil-square me-2 text-warning"></i>Editar Cliente
                {% else %}
                    <i class="bi bi-person-plus me-2 text-primary"></i>Nuevo Cliente
                {% endif %}
            </h1>
            <p class="text-muted mb-0">
                {% if object %}
                    Modifique la información del cliente {{ object.get_full_name }}
                {% else %}
                    Complete la información para registrar un nuevo cliente
                {% endif %}
            </p>
        </div>
        <a href="{% url 'customers:customer_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver al Listado
        </a>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-step active" id="step1">
            <i class="bi bi-person"></i>
        </div>
        <div class="progress-line" id="line1"></div>
        <div class="progress-step pending" id="step2">
            <i class="bi bi-geo-alt"></i>
        </div>
        <div class="progress-line" id="line2"></div>
        <div class="progress-step pending" id="step3">
            <i class="bi bi-info-circle"></i>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <form method="post" class="needs-validation" novalidate id="customerForm">
                {% csrf_token %}
                
                <!-- Información Personal -->
                <div class="form-section" id="section1">
                    <div class="section-header">
                        <div class="section-icon personal">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 text-dark fw-bold">Información Personal</h5>
                            <p class="text-muted mb-0">Datos básicos del cliente</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.first_name }}
                                <label for="{{ form.first_name.id_for_label }}">
                                    <i class="bi bi-person me-1"></i>{{ form.first_name.label }}
                                </label>
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback d-block">{{ form.first_name.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.last_name }}
                                <label for="{{ form.last_name.id_for_label }}">
                                    <i class="bi bi-person me-1"></i>{{ form.last_name.label }}
                                </label>
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback d-block">{{ form.last_name.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.email }}
                                <label for="{{ form.email.id_for_label }}">
                                    <i class="bi bi-envelope me-1"></i>{{ form.email.label }}
                                </label>
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ form.email.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.phone }}
                                <label for="{{ form.phone.id_for_label }}">
                                    <i class="bi bi-telephone me-1"></i>{{ form.phone.label }}
                                </label>
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback d-block">{{ form.phone.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.document }}
                                <label for="{{ form.document.id_for_label }}">
                                    <i class="bi bi-card-text me-1"></i>{{ form.document.label }}
                                </label>
                                {% if form.document.errors %}
                                    <div class="invalid-feedback d-block">{{ form.document.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.birth_date.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-calendar me-1"></i>{{ form.birth_date.label }}
                            </label>
                            {{ form.birth_date }}
                            {% if form.birth_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.birth_date.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Información de Dirección -->
                <div class="form-section" id="section2">
                    <div class="section-header">
                        <div class="section-icon address">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 text-dark fw-bold">Información de Dirección</h5>
                            <p class="text-muted mb-0">Ubicación y datos de contacto</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="form-floating">
                                {{ form.street }}
                                <label for="{{ form.street.id_for_label }}">
                                    <i class="bi bi-signpost me-1"></i>{{ form.street.label }}
                                </label>
                                {% if form.street.errors %}
                                    <div class="invalid-feedback d-block">{{ form.street.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                {{ form.number }}
                                <label for="{{ form.number.id_for_label }}">
                                    <i class="bi bi-hash me-1"></i>{{ form.number.label }}
                                </label>
                                {% if form.number.errors %}
                                    <div class="invalid-feedback d-block">{{ form.number.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.neighborhood }}
                                <label for="{{ form.neighborhood.id_for_label }}">
                                    <i class="bi bi-building me-1"></i>{{ form.neighborhood.label }}
                                </label>
                                {% if form.neighborhood.errors %}
                                    <div class="invalid-feedback d-block">{{ form.neighborhood.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.country.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-globe me-1"></i>{{ form.country.label }}
                            </label>
                            {{ form.country }}
                            {% if form.country.errors %}
                                <div class="invalid-feedback d-block">{{ form.country.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.province.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-map me-1"></i>{{ form.province.label }}
                            </label>
                            {{ form.province }}
                            {% if form.province.errors %}
                                <div class="invalid-feedback d-block">{{ form.province.errors|first }}</div>
                            {% endif %}
                            <div class="form-text">Selecciona un país primero</div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.locality.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-pin-map me-1"></i>{{ form.locality.label }}
                            </label>
                            {{ form.locality }}
                            {% if form.locality.errors %}
                                <div class="invalid-feedback d-block">{{ form.locality.errors|first }}</div>
                            {% endif %}
                            <div class="form-text">Selecciona una provincia primero</div>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="form-section" id="section3">
                    <div class="section-header">
                        <div class="section-icon additional">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 text-dark fw-bold">Información Adicional</h5>
                            <p class="text-muted mb-0">Datos complementarios del cliente</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.profession }}
                                <label for="{{ form.profession.id_for_label }}">
                                    <i class="bi bi-briefcase me-1"></i>{{ form.profession.label }}
                                </label>
                                {% if form.profession.errors %}
                                    <div class="invalid-feedback d-block">{{ form.profession.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-chat-text me-1"></i>{{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">{{ form.notes.errors|first }}</div>
                            {% endif %}
                            <div class="form-text">Información adicional sobre el cliente</div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="form-section">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn-action btn btn-primary">
                                <i class="bi bi-save"></i>
                                {% if object %}Guardar Cambios{% else %}Crear Cliente{% endif %}
                            </button>
                            <a href="{% url 'customers:customer_list' %}" class="btn-action btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i>Cancelar
                            </a>
                        </div>
                        {% if object %}
                        <a href="{% url 'customers:customer_delete' object.pk %}" 
                           class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('¿Está seguro de eliminar este cliente? Esta acción no se puede deshacer.')">
                            <i class="bi bi-trash me-1"></i>Eliminar Cliente
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% load static %}
<script src="{% static 'js/owner-autocomplete.js' %}"></script>
<script src="{% static 'js/location-autocomplete.js' %}"></script>

<script>
$(document).ready(function() {
    // Progress indicator functionality
    function updateProgress() {
        const sections = ['section1', 'section2', 'section3'];
        const steps = ['step1', 'step2', 'step3'];
        const lines = ['line1', 'line2'];
        
        sections.forEach((sectionId, index) => {
            const section = document.getElementById(sectionId);
            const step = document.getElementById(steps[index]);
            const inputs = section.querySelectorAll('input[required], select[required]');
            let filled = 0;
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') filled++;
            });
            
            if (filled === inputs.length && inputs.length > 0) {
                step.className = 'progress-step completed';
                if (lines[index - 1]) {
                    document.getElementById(lines[index - 1]).className = 'progress-line completed';
                }
            } else if (filled > 0) {
                step.className = 'progress-step active';
            } else {
                step.className = 'progress-step pending';
            }
        });
    }

    // Initialize Select2 for location fields
    $('#id_country').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona un país',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_countries' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { term: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    const provinceSelect = $('#id_province').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona una provincia',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_provinces' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term,
                    country_id: $('#id_country').val()
                };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    const localitySelect = $('#id_locality').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona una localidad',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_localities' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term,
                    province_id: $('#id_province').val()
                };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    // Handle dependencies
    $('#id_country').on('change', function() {
        provinceSelect.val(null).trigger('change');
        localitySelect.val(null).trigger('change');
        provinceSelect.prop('disabled', !$(this).val());
        localitySelect.prop('disabled', true);
        updateProgress();
    });

    $('#id_province').on('change', function() {
        localitySelect.val(null).trigger('change');
        localitySelect.prop('disabled', !$(this).val());
        updateProgress();
    });

    $('#id_locality').on('change', updateProgress);

    // Initial state
    const initialCountry = $('#id_country').val();
    const initialProvince = $('#id_province').val();
    provinceSelect.prop('disabled', !initialCountry);
    localitySelect.prop('disabled', !initialProvince);

    // Update progress on input changes
    $('input, select, textarea').on('input change', updateProgress);
    
    // Initial progress update
    updateProgress();

    // Form validation
    $('#customerForm').on('submit', function(e) {
        const form = this;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Smooth scroll to sections on step click
    $('.progress-step').on('click', function() {
        const stepIndex = $(this).attr('id').replace('step', '');
        const targetSection = $('#section' + stepIndex);
        if (targetSection.length) {
            $('html, body').animate({
                scrollTop: targetSection.offset().top - 100
            }, 500);
        }
    });
});
</script>
{% endblock %}
