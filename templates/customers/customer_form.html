{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}
        Editar Cliente - {{ object.get_full_name }}
    {% else %}
        Nuevo Cliente
    {% endif %}
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Moderno -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb" class="breadcrumb-modern mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'customers:customer_list' %}" class="text-decoration-none">
                            <i class="bi bi-people me-2"></i>Clientes
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {% if object %}Editar Cliente{% else %}Nuevo Cliente{% endif %}
                    </li>
                </ol>
            </nav>
            <h1 class="h2 text-dark mb-2">
                {% if object %}
                    <i class="bi bi-pencil-square me-3 text-warning"></i>Editar Cliente
                {% else %}
                    <i class="bi bi-person-plus me-3 text-primary"></i>Nuevo Cliente
                {% endif %}
            </h1>
            <p class="text-muted mb-0">
                {% if object %}
                    Modifique la información del cliente {{ object.get_full_name }}
                {% else %}
                    Complete la información para registrar un nuevo cliente
                {% endif %}
            </p>
        </div>
        <a href="{% url 'customers:customer_list' %}" class="btn btn-outline-secondary btn-modern">
            <i class="bi bi-arrow-left me-2"></i>Volver al Listado
        </a>
    </div>

    <!-- Indicador de Progreso Moderno -->
    <div class="form-progress-indicator">
        <div class="progress-step-modern active" id="step1">
            <i class="bi bi-person"></i>
        </div>
        <div class="progress-line-modern" id="line1"></div>
        <div class="progress-step-modern pending" id="step2">
            <i class="bi bi-geo-alt"></i>
        </div>
        <div class="progress-line-modern" id="line2"></div>
        <div class="progress-step-modern pending" id="step3">
            <i class="bi bi-info-circle"></i>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <form method="post" class="needs-validation" novalidate id="customerForm">
                {% csrf_token %}
                
                <!-- Información Personal -->
                <div class="form-section-modern" id="section1">
                    <div class="form-section-header">
                        <div class="form-section-icon personal">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Información Personal</h5>
                            <p class="text-muted mb-0">Datos básicos del cliente</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.first_name }}
                                <label for="{{ form.first_name.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-person me-2"></i>{{ form.first_name.label }}
                                </label>
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback d-block">{{ form.first_name.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.last_name }}
                                <label for="{{ form.last_name.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-person me-2"></i>{{ form.last_name.label }}
                                </label>
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback d-block">{{ form.last_name.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.email }}
                                <label for="{{ form.email.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-envelope me-2"></i>{{ form.email.label }}
                                </label>
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ form.email.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.phone }}
                                <label for="{{ form.phone.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-telephone me-2"></i>{{ form.phone.label }}
                                </label>
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback d-block">{{ form.phone.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.document }}
                                <label for="{{ form.document.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-card-text me-2"></i>{{ form.document.label }}
                                </label>
                                {% if form.document.errors %}
                                    <div class="invalid-feedback d-block">{{ form.document.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.birth_date.id_for_label }}" class="form-label-modern">
                                <i class="bi bi-calendar me-2"></i>{{ form.birth_date.label }}
                            </label>
                            {{ form.birth_date }}
                            {% if form.birth_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.birth_date.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Información de Dirección -->
                <div class="form-section-modern" id="section2">
                    <div class="form-section-header">
                        <div class="form-section-icon address">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Información de Dirección</h5>
                            <p class="text-muted mb-0">Ubicación y datos de contacto</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="form-floating-modern">
                                {{ form.street }}
                                <label for="{{ form.street.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-signpost me-2"></i>{{ form.street.label }}
                                </label>
                                {% if form.street.errors %}
                                    <div class="invalid-feedback d-block">{{ form.street.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating-modern">
                                {{ form.number }}
                                <label for="{{ form.number.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-hash me-2"></i>{{ form.number.label }}
                                </label>
                                {% if form.number.errors %}
                                    <div class="invalid-feedback d-block">{{ form.number.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.neighborhood }}
                                <label for="{{ form.neighborhood.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-building me-2"></i>{{ form.neighborhood.label }}
                                </label>
                                {% if form.neighborhood.errors %}
                                    <div class="invalid-feedback d-block">{{ form.neighborhood.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.country.id_for_label }}" class="form-label-modern">
                                <i class="bi bi-globe me-2"></i>{{ form.country.label }}
                            </label>
                            {{ form.country }}
                            {% if form.country.errors %}
                                <div class="invalid-feedback d-block">{{ form.country.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.province.id_for_label }}" class="form-label-modern">
                                <i class="bi bi-map me-2"></i>{{ form.province.label }}
                            </label>
                            {{ form.province }}
                            {% if form.province.errors %}
                                <div class="invalid-feedback d-block">{{ form.province.errors|first }}</div>
                            {% endif %}
                            <div class="form-text-modern">Selecciona un país primero</div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.locality.id_for_label }}" class="form-label-modern">
                                <i class="bi bi-pin-map me-2"></i>{{ form.locality.label }}
                            </label>
                            {{ form.locality }}
                            {% if form.locality.errors %}
                                <div class="invalid-feedback d-block">{{ form.locality.errors|first }}</div>
                            {% endif %}
                            <div class="form-text-modern">Selecciona una provincia primero</div>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="form-section-modern" id="section3">
                    <div class="form-section-header">
                        <div class="form-section-icon additional">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Información Adicional</h5>
                            <p class="text-muted mb-0">Datos complementarios del cliente</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                {{ form.profession }}
                                <label for="{{ form.profession.id_for_label }}" class="form-label-modern">
                                    <i class="bi bi-briefcase me-2"></i>{{ form.profession.label }}
                                </label>
                                {% if form.profession.errors %}
                                    <div class="invalid-feedback d-block">{{ form.profession.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="{{ form.notes.id_for_label }}" class="form-label-modern">
                                <i class="bi bi-chat-text me-2"></i>{{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">{{ form.notes.errors|first }}</div>
                            {% endif %}
                            <div class="form-text-modern">Información adicional sobre el cliente</div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción Modernos -->
                <div class="form-section-modern">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3">
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary btn-modern">
                                <i class="bi bi-save me-2"></i>
                                {% if object %}Guardar Cambios{% else %}Crear Cliente{% endif %}
                            </button>
                            <a href="{% url 'customers:customer_list' %}" class="btn btn-outline-secondary btn-modern">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                        </div>
                        {% if object %}
                        <a href="{% url 'customers:customer_delete' object.pk %}" 
                           class="btn btn-outline-danger btn-sm btn-modern"
                           onclick="return confirm('¿Está seguro de eliminar este cliente? Esta acción no se puede deshacer.')">
                            <i class="bi bi-trash me-2"></i>Eliminar Cliente
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% load static %}
<script src="{% static 'js/owner-autocomplete.js' %}"></script>
<script src="{% static 'js/location-autocomplete.js' %}"></script>

<script>
$(document).ready(function() {
    // Progress indicator functionality
    function updateProgress() {
        const sections = ['section1', 'section2', 'section3'];
        const steps = ['step1', 'step2', 'step3'];
        const lines = ['line1', 'line2'];
        
        sections.forEach((sectionId, index) => {
            const section = document.getElementById(sectionId);
            const step = document.getElementById(steps[index]);
            const inputs = section.querySelectorAll('input[required], select[required]');
            let filled = 0;
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') filled++;
            });
            
            if (filled === inputs.length && inputs.length > 0) {
                step.className = 'progress-step-modern completed';
                if (lines[index - 1]) {
                    document.getElementById(lines[index - 1]).className = 'progress-line-modern completed';
                }
            } else if (filled > 0) {
                step.className = 'progress-step-modern active';
            } else {
                step.className = 'progress-step-modern pending';
            }
        });
    }

    // Initialize Select2 for location fields
    $('#id_country').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona un país',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_countries' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { term: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    const provinceSelect = $('#id_province').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona una provincia',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_provinces' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term,
                    country_id: $('#id_country').val()
                };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    const localitySelect = $('#id_locality').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecciona una localidad',
        allowClear: true,
        ajax: {
            url: "{% url 'properties:autocomplete_localities' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term,
                    province_id: $('#id_province').val()
                };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    });

    // Handle dependencies
    $('#id_country').on('change', function() {
        provinceSelect.val(null).trigger('change');
        localitySelect.val(null).trigger('change');
        provinceSelect.prop('disabled', !$(this).val());
        localitySelect.prop('disabled', true);
        updateProgress();
    });

    $('#id_province').on('change', function() {
        localitySelect.val(null).trigger('change');
        localitySelect.prop('disabled', !$(this).val());
        updateProgress();
    });

    $('#id_locality').on('change', updateProgress);

    // Initial state
    const initialCountry = $('#id_country').val();
    const initialProvince = $('#id_province').val();
    provinceSelect.prop('disabled', !initialCountry);
    localitySelect.prop('disabled', !initialProvince);

    // Update progress on input changes
    $('input, select, textarea').on('input change', updateProgress);
    
    // Initial progress update
    updateProgress();

    // Form validation
    $('#customerForm').on('submit', function(e) {
        const form = this;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Smooth scroll to sections on step click
    $('.progress-step-modern').on('click', function() {
        const stepIndex = $(this).attr('id').replace('step', '');
        const targetSection = $('#section' + stepIndex);
        if (targetSection.length) {
            $('html, body').animate({
                scrollTop: targetSection.offset().top - 100
            }, 500);
        }
    });
});
</script>
{% endblock %}
