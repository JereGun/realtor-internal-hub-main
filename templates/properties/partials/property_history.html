{% load static %}

<!-- Property History -->
<div class="card-modern mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>Historial de la Propiedad
            </h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistoryDetails()">
                <i class="bi bi-eye me-1"></i>Ver Detalles
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Timeline -->
        <div class="timeline">
            <!-- Creation -->
            <div class="timeline-item">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="bg-success rounded-circle p-2">
                            <i class="bi bi-plus-circle text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">Propiedad Creada</h6>
                            <small class="text-muted">{{ property.created_at|date:"d/m/Y H:i" }}</small>
                        </div>
                        <p class="text-muted mb-0">
                            La propiedad fue registrada en el sistema por {{ property.agent.get_full_name }}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Last Update -->
            {% if property.updated_at != property.created_at %}
            <div class="timeline-item mt-3">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="bg-info rounded-circle p-2">
                            <i class="bi bi-pencil text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">Última Actualización</h6>
                            <small class="text-muted">{{ property.updated_at|date:"d/m/Y H:i" }}</small>
                        </div>
                        <p class="text-muted mb-0">
                            Información de la propiedad actualizada
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% comment %}
            <!-- Price Changes -->
            {% if property.price_history.all %}
            {% for price_change in property.price_history.all|slice:":3" %}
            <div class="property-timeline-item">
                <div class="property-timeline-marker bg-warning">
                    <i class="bi bi-currency-dollar text-white"></i>
                </div>
                <div class="property-timeline-content">
                    <div class="property-timeline-header">
                        <h6 class="property-timeline-title">Cambio de Precio</h6>
                        <span class="property-timeline-date">{{ price_change.date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="property-timeline-description">
                        {% if price_change.price_type == 'sale' %}
                        Precio de venta: ${{ price_change.price }}
                        {% else %}
                        Precio de alquiler: ${{ price_change.price }}/mes
                        {% endif %}
                        {% if price_change.previous_price %}
                        <span class="text-muted">(anterior: ${{ price_change.previous_price }})</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endcomment %}
            
            {% comment %}
            <!-- Status Changes -->
            {% if property.status_history.all %}
            {% for status_change in property.status_history.all|slice:":3" %}
            <div class="property-timeline-item">
                <div class="property-timeline-marker bg-primary">
                    <i class="bi bi-flag text-white"></i>
                </div>
                <div class="property-timeline-content">
                    <div class="property-timeline-header">
                        <h6 class="property-timeline-title">Cambio de Estado</h6>
                        <span class="property-timeline-date">{{ status_change.date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="property-timeline-description">
                        Estado cambiado a: <strong>{{ status_change.status.name }}</strong>
                        {% if status_change.notes %}
                        <br><small class="text-muted">{{ status_change.notes }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endcomment %}
            
            <!-- Contracts -->
            {% if contracts %}
            {% for contract in contracts|slice:":2" %}
            <div class="timeline-item mt-3">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="bg-secondary rounded-circle p-2">
                            <i class="bi bi-file-earmark-text text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">Contrato {{ contract.get_contract_type_display }}</h6>
                            <small class="text-muted">{{ contract.start_date|date:"d/m/Y" }}</small>
                        </div>
                        <p class="text-muted mb-1">
                            Contrato con {{ contract.customer.get_full_name }} por ${{ contract.amount|intcomma }}
                        </p>
                        <small class="text-muted">Estado: {{ contract.get_status_display }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        
        {% comment %}
        <!-- Extended History (Hidden by default) -->
        <div id="extendedHistory" class="property-extended-history d-none mt-4">
            <div class="property-history-section">
                <h6 class="property-subsection-title">
                    <i class="bi bi-graph-up me-2"></i>Estadísticas de Visualización
                </h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="property-stat-card">
                            <div class="property-stat-value">{{ property.view_count|default:"0" }}</div>
                            <div class="property-stat-label">Visualizaciones</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="property-stat-card">
                            <div class="property-stat-value">{{ property.inquiry_count|default:"0" }}</div>
                            <div class="property-stat-label">Consultas</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="property-stat-card">
                            <div class="property-stat-value">{{ property.days_on_market|default:"0" }}</div>
                            <div class="property-stat-label">Días en Mercado</div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if property.maintenance_history.all %}
            <div class="property-history-section mt-4">
                <h6 class="property-subsection-title">
                    <i class="bi bi-tools me-2"></i>Historial de Mantenimiento
                </h6>
                <div class="property-maintenance-list">
                    {% for maintenance in property.maintenance_history.all|slice:":5" %}
                    <div class="property-maintenance-item">
                        <div class="property-maintenance-date">
                            {{ maintenance.date|date:"d/m/Y" }}
                        </div>
                        <div class="property-maintenance-info">
                            <div class="property-maintenance-title">{{ maintenance.title }}</div>
                            <div class="property-maintenance-description">{{ maintenance.description }}</div>
                            {% if maintenance.cost %}
                            <div class="property-maintenance-cost">
                                Costo: ${{ maintenance.cost }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endcomment %}
        
        <!-- Show More Button -->
        <div class="property-history-actions mt-4 text-center">
            <button class="btn btn-outline-primary btn-sm" onclick="toggleHistoryDetails()">
                <span class="show-more-text">
                    <i class="bi bi-chevron-down me-1"></i>Ver Historial Completo
                </span>
                <span class="show-less-text d-none">
                    <i class="bi bi-chevron-up me-1"></i>Ocultar Detalles
                </span>
            </button>
        </div>
    </div>
</div>