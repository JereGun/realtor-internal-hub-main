<div class="sidebar bg-light position-fixed d-flex flex-column p-3 vh-100 shadow-sm" style="width: 250px;" id="sidebar">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'properties:property_list' %}" class="navbar-brand d-flex align-items-center">
            <i class="bi bi-house-door fs-4 me-2"></i> <strong>InmoGest</strong>
        </a>
        <button class="btn btn-sm btn-light border-0 text-secondary" onclick="toggleSidebar()" title="Colapsar menú">
            <i class="bi bi-chevron-double-left"></i>
        </button>
    </div>

    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="{% url 'core:dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'properties:property_list' %}" class="nav-link {% if request.resolver_match.url_name == 'property_list' %}active{% endif %}">
                <i class="bi bi-house me-2"></i> Propiedades
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'customers:customer_list' %}" class="nav-link {% if request.resolver_match.url_name == 'customer_list' %}active{% endif %}">
                <i class="bi bi-people me-2"></i> Clientes
            </a>
        </li>

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {% if request.resolver_match.app_name == 'contracts' %}active{% endif %}" href="#" id="contractsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-file-earmark-text me-2"></i> Contratos
            </a>
            <ul class="dropdown-menu dropdown-menu-light" aria-labelledby="contractsDropdown">
                <li>
                    <a class="dropdown-item {% if request.resolver_match.url_name == 'contract_list' and request.resolver_match.app_name == 'contracts' %}active{% endif %}" href="{% url 'contracts:contract_list' %}">
                        Listar Contratos
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.resolver_match.url_name == 'contract_create' and request.resolver_match.app_name == 'contracts' %}active{% endif %}" href="{% url 'contracts:contract_create' %}">
                        Nuevo Contrato
                    </a>
                </li>
            </ul>
        </li>

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {% if request.resolver_match.app_name == 'accounting' %}active{% endif %}" href="#" id="accountingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-calculator me-2"></i> Contabilidad
            </a>
            <ul class="dropdown-menu dropdown-menu-light" aria-labelledby="accountingDropdown">
                <li>
                    <a class="dropdown-item {% if request.resolver_match.url_name == 'invoice_list' and request.resolver_match.app_name == 'accounting' %}active{% endif %}" href="{% url 'accounting:invoice_list' %}">
                        Facturas
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.resolver_match.url_name == 'invoice_create' and request.resolver_match.app_name == 'accounting' %}active{% endif %}" href="{% url 'accounting:invoice_create' %}">
                        Nueva Factura
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item disabled" href="#">Reportes (próximamente)</a></li>
            </ul>
        </li>

        <li class="nav-item">
            <a href="{% url 'agents:agent_list' %}" class="nav-link {% if request.resolver_match.url_name == 'agent_list' and request.resolver_match.app_name == 'agents' %}active{% endif %}">
                <i class="bi bi-person-badge me-2"></i> Agentes
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'notifications:task_list' %}" class="nav-link {% if request.resolver_match.url_name == 'task_list' and request.resolver_match.app_name == 'notifications' %}active{% endif %}">
                <i class="bi bi-bell me-2"></i> Notificaciones
                {% if unread_notifications_count > 0 %}
                    <span class="badge bg-danger rounded-pill">{{ unread_notifications_count }}</span>
                {% endif %}
            </a>
        </li>
    </ul>

    <div class="mt-auto pt-3 border-top">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            {% load static %}
            {# Comprueba si el usuario (que es un agente) tiene una imagen #}
            {% if user.image_path %}
                <img src="{{ user.image_path.url }}" alt="Perfil de {{ user.get_full_name }}" width="32" height="32" class="rounded-circle me-2 object-fit-cover">
            {% else %}
                {# Usa el tag 'static' para la ruta correcta de la imagen por defecto #}
                <img src="{% static 'default-profile.png' %}" alt="Perfil por defecto" width="32" height="32" class="rounded-circle me-2">
            {% endif %}
            <strong>{{ user.get_full_name }}</strong>
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'agents:profile' %}"><i class="bi bi-person-circle me-2"></i> Mi Perfil</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Configuración</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'agents:logout' %}"><i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión</a></li>
        </ul>
    </div>
</div>