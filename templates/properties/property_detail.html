{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block page_title %}{{ property.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/property-styles.css' %}">
<link rel="stylesheet" href="{% static 'css/property-form.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Modern Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div>
                    <h1 class="h2 mb-2 text-white fw-bold">
                        <i class="bi bi-house-door me-2"></i>{{ property.title }}
                    </h1>
                    <div class="mb-2 opacity-90">
                        <i class="bi bi-geo-alt me-1"></i>
                        <span>{{ property.full_address }}</span>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-light text-dark">{{ property.property_type.name }}</span>
                        <span class="badge {% if property.property_status.name == 'Disponible' %}bg-success{% elif property.property_status.name == 'Vendida' %}bg-danger{% elif property.property_status.name == 'Alquilada' %}bg-info{% elif property.property_status.name == 'En Proceso' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ property.property_status.name }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <a href="{% url 'properties:property_edit' property.pk %}" class="btn-modern btn-warning">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </a>
                    <a href="{% url 'properties:property_delete' property.pk %}" class="btn-modern btn-outline-light">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </a>
                    <a href="{% url 'properties:property_list' %}" class="btn-modern btn-outline-light">
                        <i class="bi bi-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Two-Column Layout -->
    <div class="property-detail-layout">
        <div class="row g-4">
            <!-- Main Content Column -->
            <div class="col-lg-8">
                <!-- Modern Image Gallery -->
                {% if property.images.all %}
                <div class="card-modern mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-images me-2"></i>Galería de Imágenes
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info">
                                    {{ property.images.count }} imagen{{ property.images.count|pluralize:"es" }}
                                </span>
                                <a href="{% url 'properties:add_image' property.pk %}" class="btn-modern btn-primary btn-sm">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                    
                    <div class="property-gallery-main">
                        <div id="propertyCarousel" class="property-carousel" data-bs-ride="carousel">
                            <div class="carousel-inner property-carousel-inner">
                                {% for image in property.images.all %}
                                <div class="carousel-item property-carousel-item {% if forloop.first %}active{% endif %}">
                                    <div class="property-image-container">
                                        <img src="{{ image.image.url }}" class="property-gallery-image" 
                                             alt="{{ property.title }}" loading="{% if forloop.first %}eager{% else %}lazy{% endif %}">
                                        <div class="property-image-overlay">
                                            <div class="property-image-caption">
                                                <p class="mb-0">{{ image.description|default:'Imagen de la propiedad' }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if property.images.count > 1 %}
                            <!-- Enhanced Carousel Controls -->
                            <button class="property-carousel-control property-carousel-control-prev" type="button" 
                                    data-bs-target="#propertyCarousel" data-bs-slide="prev">
                                <i class="bi bi-chevron-left"></i>
                                <span class="visually-hidden">Anterior</span>
                            </button>
                            <button class="property-carousel-control property-carousel-control-next" type="button" 
                                    data-bs-target="#propertyCarousel" data-bs-slide="next">
                                <i class="bi bi-chevron-right"></i>
                                <span class="visually-hidden">Siguiente</span>
                            </button>
                            
                            <!-- Enhanced Carousel Indicators -->
                            <div class="property-carousel-indicators">
                                {% for image in property.images.all %}
                                <button type="button" class="property-carousel-indicator {% if forloop.first %}active{% endif %}" 
                                        data-bs-target="#propertyCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                                        aria-label="Imagen {{ forloop.counter }}">
                                    <span class="property-indicator-number">{{ forloop.counter }}</span>
                                </button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Thumbnail Navigation -->
                        {% if property.images.count > 1 %}
                        <div class="property-thumbnail-nav">
                            {% for image in property.images.all %}
                            <button class="property-thumbnail {% if forloop.first %}active{% endif %}" 
                                    data-bs-target="#propertyCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
                                <img src="{{ image.image.url }}" alt="Miniatura {{ forloop.counter }}" class="property-thumbnail-image">
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="card-modern mb-4 text-center py-5">
                    <div class="card-body">
                        <div class="bg-light rounded-circle p-4 d-inline-flex mb-3">
                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                        </div>
                        <h5 class="text-muted mb-2">Sin imágenes</h5>
                        <p class="text-muted mb-3">Esta propiedad no tiene imágenes cargadas</p>
                        <a href="{% url 'properties:add_image' property.pk %}" class="btn-modern btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Primera Imagen
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Modern Information Layout -->
                <div class="property-info-container">
                    {% if property.description %}
                    <div class="card-modern mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-card-text me-2"></i>Descripción
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ property.description|linebreaksbr }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="property-features-grid">
                        <!-- Main Features Card -->
                        <div class="card-modern mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-house-gear me-2"></i>Características Principales
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    {% if property.bedrooms %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                            <div class="bg-primary rounded-circle p-2 me-3">
                                                <i class="bi bi-door-closed text-white"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ property.bedrooms }}</div>
                                                <small class="text-muted">Dormitorios</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if property.bathrooms %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                            <div class="bg-info rounded-circle p-2 me-3">
                                                <i class="bi bi-droplet text-white"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ property.bathrooms }}</div>
                                                <small class="text-muted">Baños</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if property.total_surface %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                            <div class="bg-warning rounded-circle p-2 me-3">
                                                <i class="bi bi-rulers text-white"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ property.total_surface }} m²</div>
                                                <small class="text-muted">Superficie Total</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if property.garage %}
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-success">
                                            <i class="bi bi-car-front"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Garage</span>
                                            <span class="property-feature-value">Disponible</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if property.furnished %}
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-info">
                                            <i class="bi bi-house-check"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Amueblado</span>
                                            <span class="property-feature-value">Sí</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- General Information Card -->
                        <div class="property-info-card property-general-card">
                            <div class="property-info-header">
                                <h5 class="property-section-title">
                                    <i class="bi bi-info-square me-2"></i>Información General
                                </h5>
                            </div>
                            <div class="property-info-content">
                                <div class="property-feature-list">
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-primary">
                                            <i class="bi bi-house"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Tipo</span>
                                            <span class="property-feature-value">{{ property.property_type.name }}</span>
                                        </div>
                                    </div>
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-warning">
                                            <i class="bi bi-flag"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Estado</span>
                                            <span class="property-feature-value">{{ property.property_status.name }}</span>
                                        </div>
                                    </div>
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-info">
                                            <i class="bi bi-person-badge"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Agente</span>
                                            <span class="property-feature-value">{{ property.agent.get_full_name }}</span>
                                        </div>
                                    </div>
                                    {% if property.year_built %}
                                    <div class="property-feature-item">
                                        <div class="property-feature-icon property-feature-icon-secondary">
                                            <i class="bi bi-calendar"></i>
                                        </div>
                                        <div class="property-feature-content">
                                            <span class="property-feature-label">Año de Construcción</span>
                                            <span class="property-feature-value">{{ property.year_built }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property Metadata -->
                    <div class="property-metadata">
                        <div class="property-metadata-item">
                            <i class="bi bi-calendar-plus me-1"></i>
                            <span>Creado: {{ property.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                        <div class="property-metadata-item">
                            <i class="bi bi-pencil-square me-1"></i>
                            <span>Modificado: {{ property.updated_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                </div>
        </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4">
                <!-- Enhanced Price Display -->
                <div class="property-pricing-container mb-4">
                    <div class="property-pricing-header">
                        <h5 class="property-section-title">
                            <i class="bi bi-currency-dollar me-2"></i>Información de Precios
                        </h5>
                    </div>
                    <div class="property-pricing-content">
                        {% if property.sale_price %}
                        <div class="property-price-card property-price-sale">
                            <div class="property-price-icon">
                                <i class="bi bi-tag"></i>
                            </div>
                            <div class="property-price-info">
                                <div class="property-price-label">Precio de Venta</div>
                                <div class="property-price-amount">${{ property.sale_price|intcomma }}</div>
                                <div class="property-price-note">Precio final</div>
                            </div>
                            <div class="property-price-badge">
                                <span class="property-badge property-badge-success">Venta</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if property.rental_price %}
                        <div class="property-price-card property-price-rental">
                            <div class="property-price-icon">
                                <i class="bi bi-calendar-month"></i>
                            </div>
                            <div class="property-price-info">
                                <div class="property-price-label">Precio de Alquiler</div>
                                <div class="property-price-amount">${{ property.rental_price|intcomma }}</div>
                                <div class="property-price-note">por mes</div>
                            </div>
                            <div class="property-price-badge">
                                <span class="property-badge property-badge-info">Alquiler</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if not property.sale_price and not property.rental_price %}
                        <div class="property-price-empty">
                            <div class="property-empty-state">
                                <div class="property-empty-icon">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <p class="property-empty-description">Sin precios definidos</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Property Status Card -->
                <div class="property-status-container mb-4">
                    <div class="property-status-header">
                        <h5 class="property-section-title">
                            <i class="bi bi-flag me-2"></i>Estado Actual
                        </h5>
                    </div>
                    <div class="property-status-content">
                        <div class="property-status-badge">
                            <span class="property-badge property-badge-lg property-badge-{% if property.property_status.name == 'Disponible' %}success{% elif property.property_status.name == 'Vendida' %}danger{% elif property.property_status.name == 'Alquilada' %}info{% elif property.property_status.name == 'En Proceso' %}warning{% else %}secondary{% endif %}">
                                {{ property.property_status.name }}
                            </span>
                        </div>
                        <div class="property-status-description">
                            Estado de la propiedad
                        </div>
                    </div>
                </div>

                <!-- Contracts Section -->
                <div class="property-contracts-container mb-4">
                    <div class="property-contracts-header">
                        <h5 class="property-section-title">
                            <i class="bi bi-file-earmark-text me-2"></i>Contratos
                        </h5>
                        <a href="{% url 'contracts:contract_create' %}?property={{ property.id }}" class="property-btn property-btn-sm property-btn-success">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo
                        </a>
                    </div>
                    <div class="property-contracts-content">
                        {% if contracts %}
                        <div class="property-contracts-list">
                            {% for contract in contracts %}
                            <div class="property-contract-item">
                                <div class="property-contract-header">
                                    <h6 class="property-contract-title">
                                        <a href="{% url 'contracts:contract_detail' contract.pk %}" class="property-link">
                                            Contrato #{{ contract.id }}
                                        </a>
                                    </h6>
                                    <span class="property-contract-date">{{ contract.start_date|date:"d/m/Y" }}</span>
                                </div>
                                <div class="property-contract-details">
                                    <div class="property-contract-info">
                                        <div class="property-contract-field">
                                            <span class="property-field-label">Cliente:</span>
                                            <span class="property-field-value">{{ contract.customer.get_full_name }}</span>
                                        </div>
                                        <div class="property-contract-field">
                                            <span class="property-field-label">Monto:</span>
                                            <span class="property-field-value">${{ contract.amount|intcomma }}</span>
                                        </div>
                                        <div class="property-contract-field">
                                            <span class="property-field-label">Estado:</span>
                                            <span class="property-badge property-badge-{% if contract.status == 'active' %}success{% elif contract.status == 'draft' %}secondary{% elif contract.status == 'finished' %}info{% elif contract.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                                {{ contract.get_status_display }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="property-contract-actions">
                                    <a href="{% url 'contracts:contract_detail' contract.pk %}" class="property-btn property-btn-sm property-btn-outline-primary">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>
                                    {% if contract.status != 'finished' and contract.status != 'cancelled' %}
                                    <a href="{% url 'contracts:contract_edit' contract.pk %}" class="property-btn property-btn-sm property-btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="property-contracts-empty">
                            <div class="property-empty-state">
                                <div class="property-empty-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <p class="property-empty-description">No hay contratos registrados para esta propiedad.</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Agent Information -->
                <div class="property-agent-container">
                    <div class="property-agent-header">
                        <h5 class="property-section-title">
                            <i class="bi bi-person-badge me-2"></i>Agente Responsable
                        </h5>
                    </div>
                    <div class="property-agent-content">
                        <div class="property-agent-profile">
                            <div class="property-agent-avatar">
                                <i class="bi bi-person"></i>
                            </div>
                            <div class="property-agent-info">
                                <div class="property-agent-name">{{ property.agent.get_full_name }}</div>
                                {% if property.agent.email %}
                                <div class="property-agent-email">{{ property.agent.email }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if property.agent.phone %}
                        <div class="property-agent-contact">
                            <div class="property-contact-item">
                                <i class="bi bi-telephone me-2"></i>
                                <span>{{ property.agent.phone }}</span>
                            </div>
                        </div>
                        {% endif %}
                        <div class="property-agent-actions">
                            <a href="{% url 'agents:agent_detail' property.agent.pk %}" class="property-btn property-btn-outline-primary property-btn-sm w-100">
                                <i class="bi bi-eye me-1"></i>Ver Perfil del Agente
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% load static %}{% static 'js/property-detail.js' %}"></script>
{% endblock %}
{% endblock %}