{% extends 'base.html' %}
{% block title %}Facturas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb breadcrumb-modern">
            <li class="breadcrumb-item">
                <a href="{% url 'accounting:accounting_dashboard' %}" class="text-decoration-none">
                    <i class="bi bi-calculator me-1"></i>Contabilidad
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Facturas</li>
        </ol>
    </nav>

    <!-- Encabezado -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-2">
                    <i class="bi bi-receipt-cutoff me-3"></i>Gestión de Facturas
                </h1>
                <p class="mb-0 opacity-90">Administre y controle todas sus facturas</p>
            </div>
            <div class="d-flex gap-3">
                <a href="{% url 'accounting:invoice_create' %}" class="btn btn-light btn-modern">
                    <i class="bi bi-plus-circle me-2"></i>Nueva Factura
                </a>
                <button class="btn btn-outline-light btn-modern" type="button" data-bs-toggle="collapse"
                    data-bs-target="#filtersCard" aria-expanded="false">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="collapse mb-4" id="filtersCard">
        <div class="card card-modern">
            <div class="card-header bg-light border-bottom">
                <h5 class="mb-0 text-dark fw-bold">
                    <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="get" action="{% url 'accounting:invoice_list' %}" id="filterForm" class="needs-validation"
                    novalidate>
                    <!-- Filtros Básicos -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="searchQuery" class="form-label fw-semibold">
                                <i class="bi bi-search me-1"></i>Búsqueda General
                            </label>
                            <input type="text" name="q" id="searchQuery" class="form-control form-control-modern"
                                placeholder="Buscar por número de factura o nombre del cliente..."
                                value="{{ query|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label fw-semibold">
                                <i class="bi bi-flag me-1"></i>Estado
                            </label>
                            <select name="status" id="statusFilter" class="form-select form-control-modern">
                                <option value="">Todos los estados</option>
                                <option value="draft" {% if status == 'draft' %}selected{% endif %}>Borrador</option>
                                <option value="validated" {% if status == 'validated' %}selected{% endif %}>Validada
                                </option>
                                <option value="sent" {% if status == 'sent' %}selected{% endif %}>Enviada</option>
                                <option value="paid" {% if status == 'paid' %}selected{% endif %}>Pagada</option>
                                <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelada
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customerFilter" class="form-label fw-semibold">
                                <i class="bi bi-person me-1"></i>Cliente
                            </label>
                            <select name="customer" id="customerFilter" class="form-select form-control-modern">
                                <option value="">Todos los clientes</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" {% if customer_id|stringformat:"s" == customer.id|stringformat:"s" %}selected{% endif %}>
                                    {{ customer.get_full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Filtros Avanzados -->
                    <div class="border-top pt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">Filtros Avanzados</h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                data-bs-target="#advancedFilters">
                                <i class="bi bi-chevron-down me-1"></i>Mostrar más opciones
                            </button>
                        </div>

                        <div class="collapse" id="advancedFilters">
                            <div class="row g-3">
                                <!-- Fechas -->
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-calendar-event me-1"></i>Fecha de Emisión
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="date" name="date_from" class="form-control form-control-modern"
                                                value="{{ date_from|default:'' }}" placeholder="Desde">
                                        </div>
                                        <div class="col-6">
                                            <input type="date" name="date_to" class="form-control form-control-modern"
                                                value="{{ date_to|default:'' }}" placeholder="Hasta">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-calendar-x me-1"></i>Fecha de Vencimiento
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="date" name="due_date_from"
                                                class="form-control form-control-modern"
                                                value="{{ due_date_from|default:'' }}" placeholder="Desde">
                                        </div>
                                        <div class="col-6">
                                            <input type="date" name="due_date_to"
                                                class="form-control form-control-modern"
                                                value="{{ due_date_to|default:'' }}" placeholder="Hasta">
                                        </div>
                                    </div>
                                </div>

                                <!-- Montos -->
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-currency-dollar me-1"></i>Rango de Monto
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" name="min_amount"
                                                    class="form-control form-control-modern" step="0.01" min="0"
                                                    placeholder="Mínimo" value="{{ min_amount|default:'' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" name="max_amount"
                                                    class="form-control form-control-modern" step="0.01" min="0"
                                                    placeholder="Máximo" value="{{ max_amount|default:'' }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Opciones adicionales -->
                                <div class="col-md-6">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="contractFilter" class="form-label fw-semibold">
                                                <i class="bi bi-file-text me-1"></i>Contrato
                                            </label>
                                            <select name="contract" id="contractFilter"
                                                class="form-select form-control-modern">
                                                <option value="">Todos</option>
                                                <option value="with_contract" {% if contract == 'with_contract' %}selected{% endif %}>Con contrato</option>
                                                <option value="without_contract" {% if contract == 'without_contract' %}selected{% endif %}>Sin contrato</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="overdueSwitch"
                                                    name="overdue" value="yes" {% if overdue == 'yes' %}checked{% endif %}>
                                                <label class="form-check-label fw-semibold" for="overdueSwitch">
                                                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>Solo
                                                    facturas vencidas
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            Use los filtros para encontrar facturas específicas
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{% url 'accounting:invoice_list' %}" class="btn btn-outline-secondary btn-modern">
                                <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                            </a>
                            <button type="submit" class="btn btn-primary btn-modern">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card card-modern border-0 bg-primary text-white stat-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-receipt fs-1 mb-3 opacity-75"></i>
                    <h4 class="card-title mb-1">{{ invoices.paginator.count }}</h4>
                    <p class="card-text mb-0 opacity-90">Total Facturas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern border-0 bg-success text-white stat-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-check-circle fs-1 mb-3 opacity-75"></i>
                    <h4 class="card-title mb-1">{{ invoices.object_list|length }}</h4>
                    <p class="card-text mb-0 opacity-90">En esta página</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern border-0 bg-warning text-white stat-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-clock fs-1 mb-3 opacity-75"></i>
                    <h4 class="card-title mb-1">Pendientes</h4>
                    <p class="card-text mb-0 opacity-90">Por cobrar</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern border-0 bg-info text-white stat-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-currency-dollar fs-1 mb-3 opacity-75"></i>
                    <h4 class="card-title mb-1">Total</h4>
                    <p class="card-text mb-0 opacity-90">Facturado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones masivas -->
    <div class="card card-modern mb-4">
        <div class="card-body py-3">
            <form id="bulk-actions-form" method="post" action="{% url 'accounting:send_bulk_emails' %}">
                {% csrf_token %}
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="select-all"
                                onchange="toggleAllCheckboxes(this)">
                            <label class="form-check-label fw-semibold" for="select-all">
                                Seleccionar todas
                            </label>
                        </div>
                        <span id="selected-count" class="badge bg-primary rounded-pill">0</span>
                        <span class="text-muted ms-2">facturas seleccionadas</span>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="submit" class="btn btn-primary btn-sm btn-modern" id="send-bulk-emails" disabled>
                            <i class="bi bi-envelope me-1"></i>Enviar correos
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-modern" id="bulk-delete"
                            disabled>
                            <i class="bi bi-trash me-1"></i>Eliminar seleccionadas
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de facturas -->
    <div class="card card-modern">
        <div class="card-header bg-light border-bottom py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-dark fw-bold">
                    <i class="bi bi-table me-2"></i>Lista de Facturas
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <small class="text-muted">
                        Mostrando {{ invoices.start_index }}-{{ invoices.end_index }} de {{ invoices.paginator.count }}
                        facturas
                    </small>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" width="50" class="border-0 ps-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all-header"
                                        onchange="toggleAllCheckboxes(this)">
                                </div>
                            </th>
                            <th scope="col" class="border-0">
                                <i class="bi bi-hash text-muted me-1"></i>Número
                            </th>
                            <th scope="col" class="border-0">
                                <i class="bi bi-person text-muted me-1"></i>Cliente
                            </th>
                            <th scope="col" class="border-0">
                                <i class="bi bi-calendar-event text-muted me-1"></i>Emisión
                            </th>
                            <th scope="col" class="border-0">
                                <i class="bi bi-calendar-x text-muted me-1"></i>Vencimiento
                            </th>
                            <th scope="col" class="border-0">
                                <i class="bi bi-flag text-muted me-1"></i>Estado
                            </th>
                            <th scope="col" class="border-0 text-end">
                                <i class="bi bi-currency-dollar text-muted me-1"></i>Total
                            </th>
                            <th scope="col" class="border-0 text-center pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr class="{% if invoice.due_date < today and invoice.status == 'validated' or invoice.due_date < today and invoice.status == 'sent' %}table-warning{% endif %}">
                            <td class="ps-4">
                            <div class="form-check">
                                <input class="form-check-input invoice-checkbox" type="checkbox" name="invoice_ids"
                                    value="{{ invoice.pk }}"
                                    data-has-email="{% if invoice.customer.email %}true{% else %}false{% endif %}"
                                    data-status="{{ invoice.status }}" onchange="updateSelectedCount()">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-receipt text-primary me-2"></i>
                                <span class="fw-semibold">{{ invoice.number|default:invoice.id }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px;">
                                        <span class="text-white fw-bold small">
                                            {{ invoice.customer.first_name|first }}{{ invoice.customer.last_name|first}}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ invoice.customer.get_full_name }}</div>
                                    {% if invoice.customer.email %}
                                    <small class="text-muted">{{ invoice.customer.email }}</small>
                                    {% else %}
                                    <small class="text-warning">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Sin email
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-check text-success me-2"></i>
                                <span>{{ invoice.date|date:'d/m/Y' }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if invoice.due_date < today and invoice.status == 'validated' or invoice.due_date < today and invoice.status == 'sent' %} <i
                                    class="bi bi-exclamation-triangle text-danger me-2"></i>
                                    {% else %}
                                    <i class="bi bi-calendar-event text-muted me-2"></i>
                                    {% endif %}
                                    <span
                                        class="{% if invoice.due_date < today and invoice.status == 'validated' or invoice.due_date < today and invoice.status == 'sent' %}text-danger fw-semibold{% endif %}">
                                        {{ invoice.due_date|date:'d/m/Y' }}
                                    </span>
                            </div>
                        </td>
                        <td>
                            <span class="badge rounded-pill
                                    {% if invoice.status == 'paid' %}bg-success
                                    {% elif invoice.status == 'sent' %}bg-info
                                    {% elif invoice.status == 'validated' %}bg-warning text-dark
                                    {% elif invoice.status == 'cancelled' %}bg-danger
                                    {% else %}bg-secondary
                                    {% endif %}">
                                {{ invoice.get_status_display }}
                            </span>
                        </td>
                        <td class="text-end">
                            <span class="fw-bold text-success fs-6">${{ invoice.total_amount|floatformat:2 }}</span>
                        </td>
                        <td class="text-center pe-4">
                            <div class="btn-group" role="group">
                                <a href="{% url 'accounting:invoice_detail' invoice.pk %}"
                                    class="btn btn-sm btn-outline-primary btn-modern" title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'accounting:invoice_update' invoice.pk %}"
                                    class="btn btn-sm btn-outline-secondary btn-modern" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% if invoice.customer.email and invoice.status == 'validated' or invoice.customer.email and invoice.status == 'sent' %}
                                <a href="{% url 'accounting:send_invoice_email' invoice.pk %}"
                                    class="btn btn-sm btn-outline-info btn-modern" title="Enviar por correo">
                                    <i class="bi bi-envelope"></i>
                                </a>
                                {% endif %}
                                {% if invoice.contract and invoice.status == 'validated' or invoice.contract and invoice.status == 'sent' or invoice.contract and invoice.status == 'paid' %}
                                <button type="button" class="btn btn-sm btn-outline-warning btn-modern"
                                    onclick="showOwnerReceiptModal({{ invoice.pk }}, '{{ invoice.number|default:invoice.id }}', {% if invoice.owner_receipts.exists %}true{% else %}false{% endif %})"
                                    title="{% if invoice.owner_receipts.exists %}Ver comprobante propietario{% else %}Generar comprobante propietario{% endif %}">
                                    <i
                                        class="bi bi-{% if invoice.owner_receipts.exists %}file-check{% else %}file-plus{% endif %}"></i>
                                </button>
                                {% endif %}
                                <a href="{% url 'accounting:invoice_pdf' invoice.pk %}"
                                    class="btn btn-sm btn-outline-success btn-modern" title="Descargar PDF">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-modern"
                                    data-bs-toggle="modal" data-bs-target="#deleteInvoiceModal"
                                    data-invoice-id="{{ invoice.pk }}"
                                    data-invoice-number="{{ invoice.number|default:invoice.id }}" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-3 mb-1 fw-semibold">No hay facturas que mostrar</p>
                                    <p class="mb-0">Intente ajustar los filtros o crear una nueva factura</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Paginación -->
        {% if invoices.has_other_pages %}
        <div class="card-footer bg-light border-top">
            <nav aria-label="Paginación de facturas">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if invoices.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link"
                            href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ invoices.previous_page_number }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in invoices.paginator.page_range %}
                    {% if num == invoices.number %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > invoices.number|add:'-3' and num < invoices.number|add:'3' %} <li class="page-item">
                        <a class="page-link"
                            href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{
                            num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if invoices.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ invoices.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                                href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ invoices.paginator.num_pages }}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Función para actualizar el contador de facturas seleccionadas
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
        const count = checkboxes.length;
        document.getElementById('selected-count').textContent = count;

        // Habilitar o deshabilitar el botón de envío masivo
        const sendButton = document.getElementById('send-bulk-emails');
        sendButton.disabled = count === 0;

        // Actualizar el estado de los checkboxes de seleccionar todos
        const allCheckboxes = document.querySelectorAll('.invoice-checkbox');
        const selectAllHeader = document.getElementById('select-all-header');
        const selectAll = document.getElementById('select-all');

        if (count === 0) {
            selectAllHeader.checked = false;
            selectAll.checked = false;
            selectAllHeader.indeterminate = false;
            selectAll.indeterminate = false;
        } else if (count === allCheckboxes.length) {
            selectAllHeader.checked = true;
            selectAll.checked = true;
            selectAllHeader.indeterminate = false;
            selectAll.indeterminate = false;
        } else {
            selectAllHeader.indeterminate = true;
            selectAll.indeterminate = true;
        }
    }

    // Función para seleccionar o deseleccionar todas las facturas
    function toggleAllCheckboxes(checkbox) {
        const checkboxes = document.querySelectorAll('.invoice-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });

        // Sincronizar los dos checkboxes de seleccionar todos
        const selectAllHeader = document.getElementById('select-all-header');
        const selectAll = document.getElementById('select-all');
        selectAllHeader.checked = checkbox.checked;
        selectAll.checked = checkbox.checked;
        selectAllHeader.indeterminate = false;
        selectAll.indeterminate = false;

        updateSelectedCount();
    }

    // Configurar el formulario de acciones masivas
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('bulk-actions-form');
        const sendButton = document.getElementById('send-bulk-emails');
        const confirmButton = document.getElementById('confirm-send-emails');
        const bulkEmailModal = new bootstrap.Modal(document.getElementById('bulkEmailModal'));

        // Mostrar modal de confirmación al hacer clic en el botón de envío
        sendButton.addEventListener('click', function (e) {
            e.preventDefault();

            const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
            const emailCount = Array.from(checkboxes).filter(cb => cb.dataset.hasEmail === 'true' && (cb.dataset.status === 'validated' || cb.dataset.status === 'sent')).length;

            document.getElementById('email-count').textContent = emailCount;

            // Mostrar advertencia si hay clientes sin correo electrónico
            const hasNoEmail = Array.from(checkboxes).some(cb => cb.dataset.hasEmail === 'false');
            document.getElementById('warning-no-email').classList.toggle('d-none', !hasNoEmail);

            // Mostrar advertencia si hay facturas con estado inválido
            const hasInvalidStatus = Array.from(checkboxes).some(cb => cb.dataset.status !== 'validated' && cb.dataset.status !== 'sent');
            document.getElementById('warning-invalid-status').classList.toggle('d-none', !hasInvalidStatus);

            bulkEmailModal.show();
        });

        // Enviar el formulario al confirmar
        confirmButton.addEventListener('click', function () {
            form.submit();
            bulkEmailModal.hide();
        });
    });
</script>
<!-- Modal de confirmación de envío masivo -->
<div class="modal fade" id="bulkEmailModal" tabindex="-1" aria-labelledby="bulkEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEmailModalLabel">
                    <i class="bi bi-envelope-check text-primary me-2"></i>Enviar correos masivos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-envelope-paper text-primary" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center mb-3">
                    Se enviarán correos electrónicos a los clientes de
                    <strong><span id="email-count" class="text-primary">0</span> facturas</strong> seleccionadas.
                </p>
                <div id="warning-no-email" class="alert alert-warning d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Algunas facturas seleccionadas pertenecen a clientes sin correo electrónico y serán omitidas.
                </div>
                <div id="warning-invalid-status" class="alert alert-warning d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Solo se enviarán correos de facturas en estado "Validada" o "Enviada".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirm-send-emails">
                    <i class="bi bi-send me-1"></i>Enviar correos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" id="deleteInvoiceModal" tabindex="-1" aria-labelledby="deleteInvoiceModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteInvoiceModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Eliminar Factura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-trash text-danger" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center mb-3">
                    ¿Está seguro de que desea eliminar la factura
                    <strong>#<span id="invoiceNumber"></span></strong>?
                </p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Advertencia:</strong> Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <form id="deleteInvoiceForm" method="POST" action="" class="d-inline">
                    {% csrf_token %}
                    <button type="button" class="btn btn-danger" onclick="handleDelete();">
                        <i class="bi bi-trash me-1"></i>Eliminar Factura
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Función para mostrar toast de éxito
        function showSuccessToast(message) {
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            const toastHtml = `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <strong class="me-auto">Éxito</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();

            toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        // Función para manejar eliminación de facturas
        window.handleDelete = function () {
            const form = document.getElementById('deleteInvoiceForm');
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Eliminando...';
            submitBtn.disabled = true;

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteInvoiceModal'));
                        modal.hide();
                        showSuccessToast('Factura eliminada correctamente');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert(`Error: ${data.error || 'Error al eliminar la factura'}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar la factura. Por favor, inténtelo nuevamente.');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        };

        // Configurar modal de eliminación
        const deleteButtons = document.querySelectorAll('[data-bs-target="#deleteInvoiceModal"]');
        const invoiceNumberElement = document.getElementById('invoiceNumber');
        const deleteInvoiceForm = document.getElementById('deleteInvoiceForm');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function () {
                const invoiceId = this.dataset.invoiceId;
                const invoiceNumber = this.dataset.invoiceNumber;
                invoiceNumberElement.textContent = invoiceNumber;
                deleteInvoiceForm.action = `{% url 'accounting:invoice_delete' 0 %}`.replace('0', invoiceId);
            });
        });

        // Configurar el formulario de acciones masivas
        const form = document.getElementById('bulk-actions-form');
        const sendButton = document.getElementById('send-bulk-emails');
        const confirmButton = document.getElementById('confirm-send-emails');
        const bulkEmailModal = new bootstrap.Modal(document.getElementById('bulkEmailModal'));

        // Mostrar modal de confirmación al hacer clic en el botón de envío
        sendButton.addEventListener('click', function (e) {
            e.preventDefault();

            const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
            const emailCount = Array.from(checkboxes).filter(cb =>
                cb.dataset.hasEmail === 'true' &&
                (cb.dataset.status === 'validated' || cb.dataset.status === 'sent')
            ).length;

            document.getElementById('email-count').textContent = emailCount;

            // Mostrar advertencias
            const hasNoEmail = Array.from(checkboxes).some(cb => cb.dataset.hasEmail === 'false');
            document.getElementById('warning-no-email').classList.toggle('d-none', !hasNoEmail);

            const hasInvalidStatus = Array.from(checkboxes).some(cb =>
                cb.dataset.status !== 'validated' && cb.dataset.status !== 'sent'
            );
            document.getElementById('warning-invalid-status').classList.toggle('d-none', !hasInvalidStatus);

            bulkEmailModal.show();
        });

        // Enviar el formulario al confirmar
        confirmButton.addEventListener('click', function () {
            form.submit();
            bulkEmailModal.hide();
        });

        // Filtros en tiempo real
        const filterForm = document.getElementById('filterForm');
        const searchInput = document.getElementById('searchQuery');
        const statusSelect = document.getElementById('statusFilter');
        const customerSelect = document.getElementById('customerFilter');

        // Auto-submit en cambios de select
        [statusSelect, customerSelect].forEach(select => {
            if (select) {
                select.addEventListener('change', function () {
                    filterForm.submit();
                });
            }
        });

        // Búsqueda con delay
        let searchTimeout;
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (this.value.length >= 3 || this.value.length === 0) {
                        filterForm.submit();
                    }
                }, 500);
            });
        }

        // Inicializar contador
        updateSelectedCount();
    });

    // Función para mostrar el modal de comprobante de propietario
    function showOwnerReceiptModal(invoiceId, invoiceNumber, hasReceipt) {
        const modal = new bootstrap.Modal(document.getElementById('ownerReceiptModal'));
        const modalTitle = document.getElementById('ownerReceiptModalLabel');
        const modalBody = document.getElementById('ownerReceiptModalBody');
        const generateBtn = document.getElementById('generateOwnerReceiptBtn');
        const previewBtn = document.getElementById('previewOwnerReceiptBtn');

        if (hasReceipt) {
            modalTitle.textContent = `Comprobante de Propietario - Factura ${invoiceNumber}`;
            modalBody.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Ya existe un comprobante generado para esta factura.
            </div>
            <div class="d-grid gap-2">
                <a href="/accounting/invoice/${invoiceId}/owner-receipt-detail/" class="btn btn-primary">
                    <i class="bi bi-eye me-2"></i>Ver Comprobante Existente
                </a>
                <button type="button" class="btn btn-outline-warning" onclick="regenerateOwnerReceipt(${invoiceId})">
                    <i class="bi bi-arrow-clockwise me-2"></i>Regenerar Comprobante
                </button>
            </div>
        `;
            generateBtn.style.display = 'none';
            previewBtn.style.display = 'none';
        } else {
            modalTitle.textContent = `Generar Comprobante de Propietario - Factura ${invoiceNumber}`;
            modalBody.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Se generará un comprobante detallado para el propietario con información del alquiler y descuentos aplicados.
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="sendEmailCheck" checked>
                <label class="form-check-label" for="sendEmailCheck">
                    Enviar automáticamente por correo electrónico al propietario
                </label>
            </div>
        `;
            generateBtn.style.display = 'inline-block';
            previewBtn.style.display = 'inline-block';
            generateBtn.onclick = () => generateOwnerReceipt(invoiceId);
            previewBtn.onclick = () => previewOwnerReceipt(invoiceId);
        }

        modal.show();
    }

    // Función para generar comprobante de propietario
    function generateOwnerReceipt(invoiceId) {
        const sendEmail = document.getElementById('sendEmailCheck')?.checked || false;
        const btn = document.getElementById('generateOwnerReceiptBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generando...';

        fetch(`/contabilidad/invoice/${invoiceId}/generate-owner-receipt/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `send_email=${sendEmail}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `Comprobante ${data.receipt_number} generado exitosamente.`);
                    bootstrap.Modal.getInstance(document.getElementById('ownerReceiptModal')).hide();
                    // Actualizar la página para mostrar el nuevo estado
                    location.reload();
                } else {
                    showAlert('danger', `Error: ${data.error}`);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error al generar el comprobante. Intente nuevamente.');
                console.error('Error:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    // Función para previsualizar comprobante
    function previewOwnerReceipt(invoiceId) {
        window.open(`/accounting/invoice/${invoiceId}/preview-owner-receipt/`, '_blank');
    }

    // Función para regenerar comprobante
    function regenerateOwnerReceipt(invoiceId) {
        if (confirm('¿Está seguro de que desea regenerar el comprobante? Esto creará un nuevo comprobante.')) {
            generateOwnerReceipt(invoiceId);
        }
    }

    // Función para mostrar alertas
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>

<!-- Modal para Comprobante de Propietario -->
<div class="modal fade" id="ownerReceiptModal" tabindex="-1" aria-labelledby="ownerReceiptModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ownerReceiptModalLabel">Comprobante de Propietario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="ownerReceiptModalBody">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="previewOwnerReceiptBtn">
                    <i class="bi bi-eye me-2"></i>Vista Previa
                </button>
                <button type="button" class="btn btn-warning" id="generateOwnerReceiptBtn">
                    <i class="bi bi-file-plus me-2"></i>Generar Comprobante
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}